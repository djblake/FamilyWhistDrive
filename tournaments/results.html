<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Results | Ruston Family Whist Drive</title>
    <meta name="description" content="Detailed results and player rankings for Ruston Family Whist Drive tournament">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="/assets/js/footer-nav.js?v=4" defer></script>
    <script src="/assets/js/media.js?v=1" defer></script>
    <script src="/assets/js/lightbox.js?v=11" defer></script>
    <style>
        .hero-heading {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .hero-year {
            font-family: 'Playfair Display', serif;
            font-size: clamp(3rem, 12vw, 5.5rem);
            font-weight: 900;
            letter-spacing: 0.2rem;
            text-transform: uppercase;
            color: #f0fdf4;
            text-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
            margin-bottom: 0.75rem;
        }

        .hero-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2rem, 6vw, 3.5rem);
            margin: 0;
            color: #ffffff;
            text-shadow: 0 4px 14px rgba(0, 0, 0, 0.35);
        }

        .hero-stats {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .hero-stat {
            display: inline-flex;
            flex-direction: column;
            padding: 0.8rem 1.2rem;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.18);
            border: 1px solid rgba(255, 255, 255, 0.4);
            min-width: 160px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .hero-stat__label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: rgba(255, 255, 255, 0.8);
        }

        .hero-stat__value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
        }

        .hero-stat--muted {
            background: rgba(255, 255, 255, 0.12);
            border-style: dashed;
            color: rgba(255, 255, 255, 0.8);
        }

        .hero-comment {
            margin-top: 1.75rem;
            text-align: center;
            font-style: italic;
            color: rgba(255, 255, 255, 0.85);
            max-width: 720px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-comment .comment-label {
            display: block;
            font-style: normal;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.25em;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.4rem;
        }

        .hero-comment .comment-body {
            font-size: 1.1rem;
            color: #f8fafc;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
        }

        .cover-strip {
            margin-top: 1.25rem;
            display: none;
            justify-content: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .cover-strip a {
            width: 160px;
            height: 100px;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.28);
            background: rgba(255, 255, 255, 0.14);
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.22);
            display: inline-block;
        }

        .cover-strip a img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .tournament-photos {
            padding: var(--spacing-3xl) 0;
            background: #ffffff;
        }

        .tournament-photos .section-title {
            color: var(--text-primary-dark);
        }

        .photos-group {
            margin-top: var(--spacing-xl);
            background: #ffffff;
            border-radius: var(--border-radius-lg);
            border: 1px solid rgba(15, 23, 42, 0.10);
            box-shadow: var(--shadow-card);
            overflow: hidden;
        }

        .photos-group-header {
            padding: var(--spacing-lg) var(--spacing-xl);
            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            align-items: baseline;
        }

        .photos-group-title {
            font-weight: 950;
            color: var(--text-primary-dark);
            font-size: 1.05rem;
        }

        .photos-group-meta {
            color: var(--text-secondary-dark);
            font-weight: 800;
            font-size: 0.9rem;
        }

        .photos-grid {
            padding: var(--spacing-lg) var(--spacing-xl);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.85rem;
        }

        .photo-thumb {
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(15, 23, 42, 0.10);
            background: rgba(15, 23, 42, 0.04);
            aspect-ratio: 16 / 10;
            display: block;
        }

        .photo-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .day-actions {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .day-notes {
            margin-top: var(--spacing-xl);
            display: grid;
            gap: 0.85rem;
        }

        .day-note {
            border-radius: var(--border-radius-lg);
            border: 1px solid rgba(15, 23, 42, 0.10);
            background: #fff;
            box-shadow: var(--shadow-card);
            padding: 0.95rem 1rem;
        }
        .day-note__kicker {
            font-size: 0.75rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            font-weight: 950;
            color: var(--text-secondary-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .day-note__body {
            margin-top: 0.55rem;
            color: var(--text-primary-dark);
            font-weight: 650;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        .day-note__meta {
            margin-top: 0.6rem;
            color: var(--text-secondary-dark);
            font-size: 0.85rem;
            font-weight: 750;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .day-note__meta strong { color: var(--text-primary-dark); font-weight: 900; }

        .day-photo-row {
            margin-top: var(--spacing-xl);
            display: grid;
            grid-template-columns: repeat(6, minmax(0, 1fr));
            gap: 0.65rem;
        }
        @media (max-width: 840px) {
            .day-photo-row { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
        .day-photo-row a {
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(15, 23, 42, 0.10);
            background: rgba(15, 23, 42, 0.04);
            aspect-ratio: 16 / 10;
            display: block;
        }
        .day-photo-row img { width: 100%; height: 100%; object-fit: cover; display:block; }

        .day-photo-actions {
            margin-top: 0.75rem;
            display: flex;
            justify-content: center;
        }

        .day-empty {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 14px;
            border: 1px dashed rgba(15, 23, 42, 0.22);
            background: rgba(15, 23, 42, 0.03);
            color: var(--text-secondary-dark);
            font-weight: 750;
            text-align: center;
        }

        .day-modal {
            position: fixed;
            inset: 0;
            z-index: 99990;
        }
        .day-modal__backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.72);
        }
        .day-modal__panel {
            position: relative;
            margin: 8vh auto;
            width: min(820px, 92vw);
            background: rgba(15, 23, 42, 0.92);
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 18px;
            padding: 1rem;
            box-shadow: 0 24px 70px rgba(0,0,0,0.55);
            color: rgba(255,255,255,0.95);
        }
        .day-modal__close {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
        }
        .day-modal__title {
            margin: 0 0 0.25rem;
            font-family: var(--font-secondary);
            font-size: 1.25rem;
            font-weight: 950;
        }
        .day-modal__sub {
            margin: 0 0 0.85rem;
            color: rgba(255,255,255,0.75);
            font-weight: 700;
        }
        .day-modal__label {
            display: block;
            font-weight: 900;
            margin: 0.7rem 0 0.35rem;
        }
        .day-modal__input,
        .day-modal__textarea {
            width: 100%;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.18);
            background: rgba(0,0,0,0.20);
            color: rgba(255,255,255,0.96);
            padding: 0.75rem 0.85rem;
            font-size: 0.95rem;
            font-weight: 650;
        }
        .day-modal__textarea { resize: vertical; }
        .day-modal__actions { margin-top: 0.9rem; display:flex; gap:0.75rem; justify-content:flex-end; flex-wrap: wrap; }
        .day-modal__status { margin-top: 0.6rem; color: rgba(255,255,255,0.82); font-weight: 750; min-height: 1.2em; }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="card-suits"><span class="heart">‚ô•</span> <span class="club">‚ô£</span> <span class="diamond">‚ô¶</span> <span class="spade">‚ô†</span></div>
                    <h1 class="site-title">Ruston Family Whist Drive</h1>
                    <p class="site-subtitle">Est. 1984 ‚Ä¢ The World's Most Elite Family Tournament</p>
                </div>
                <nav class="main-nav">
                    <a href="../" class="nav-link">Home</a>
                    <a href="../tournaments/" class="nav-link">Tournaments</a>
                    <a href="../tables/" class="nav-link">Tables</a>
                    <a href="../players/" class="nav-link">Players</a>
                    <a href="../leaderboard/" class="nav-link">Hall of Fame</a>
                    <a href="../stats/" class="nav-link">Statistics</a>
                </nav>
            </div>
        </div>
    </header>

    <div id="data-issues-banner" class="data-issues-banner" style="display: none;"></div>

    <main class="main-content">
        <section class="tournament-hero" id="tournament-hero">
            <div class="container">
                <div class="hero-content">
                    <div class="tournament-badge" id="tournament-badge">üèÜ TOURNAMENT RESULTS</div>
                    <div class="hero-heading">
                        <div class="hero-year" id="tournament-year">20XX</div>
                        <h1 class="hero-title" id="tournament-title">Loading Tournament...</h1>
                    </div>
                    <div class="hero-stats" id="tournament-stats"></div>
                    <p class="hero-comment" id="tournament-comment" style="display: none;"></p>
                </div>
            </div>
        </section>

        <section class="tournament-summary">
            <div class="container">
                <div class="summary-grid" id="summary-grid">
                    <!-- Tournament summary will be loaded dynamically -->
                </div>
                <p class="tie-break-message" id="tie-break-message" style="display: none;"></p>
                <!-- Photo thumbnails + stories/quotes are rendered in the "About the day‚Ä¶" section below. -->
            </div>
        </section>

        <section class="tournament-rankings">
            <div class="container">
                <h2 class="section-title">
                    <span class="title-icon">üèÖ</span>
                    Final Rankings
                </h2>
                
                <div class="rankings-table-container">
                    <table class="rankings-table" id="rankings-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Total Tricks</th>
                                <th>Average per Round</th>
                                <th>Best Score</th>
                                <th>Worst Score</th>
                                <th>Rounds Won</th>
                                <th>Scorecard</th>
                            </tr>
                        </thead>
                        <tbody id="rankings-tbody">
                            <!-- Rankings will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="tournament-photos" id="tournament-photos" style="display:none;">
            <div class="container">
                <h2 class="section-title">
                    <span class="title-icon">üì∏</span>
                    About the day‚Ä¶
                </h2>

                <div class="day-actions">
                    <button class="btn btn-secondary" id="btn-add-story" type="button">Add story</button>
                    <button class="btn btn-secondary" id="btn-add-quote" type="button">Add quote</button>
                    <a class="btn btn-primary" id="btn-add-photos" href="#" style="display:none;">Add photos</a>
                </div>

                <div id="day-notes" class="day-notes"></div>

                <div class="day-photo-row" id="day-photo-row" aria-label="Photo highlights"></div>
                <div class="day-photo-actions">
                    <a class="btn btn-secondary" id="btn-see-gallery" href="#" style="display:none;">See more photos</a>
                </div>
                <div id="day-photo-empty" class="day-empty" style="display:none;"></div>
            </div>
        </section>

        <!-- Modal: Add story -->
        <div class="day-modal" id="modal-story" style="display:none;" aria-hidden="true">
            <div class="day-modal__backdrop" data-close="1"></div>
            <div class="day-modal__panel" role="dialog" aria-modal="true" aria-label="Add story">
                <button class="btn btn-secondary day-modal__close" type="button" data-close="1">Close</button>
                <h3 class="day-modal__title">Add a story</h3>
                <div class="day-modal__sub">Write up what happened, funny moments, and highlights.</div>
                <label class="day-modal__label" for="story-author">Your name</label>
                <input id="story-author" class="day-modal__input" type="text" placeholder="Paul">
                <label class="day-modal__label" for="story-text">Story</label>
                <textarea id="story-text" class="day-modal__textarea" rows="8" placeholder="Today‚Äôs drive was‚Ä¶"></textarea>
                <label class="day-modal__label" for="story-password">Family password</label>
                <input id="story-password" class="day-modal__input" type="password" placeholder="Family password" autocomplete="current-password">
                <div class="day-modal__actions">
                    <button class="btn btn-primary" id="btn-submit-story" type="button">Submit story</button>
                </div>
                <div class="day-modal__status" id="story-status"></div>
            </div>
        </div>

        <!-- Modal: Add quote -->
        <div class="day-modal" id="modal-quote" style="display:none;" aria-hidden="true">
            <div class="day-modal__backdrop" data-close="1"></div>
            <div class="day-modal__panel" role="dialog" aria-modal="true" aria-label="Add quote">
                <button class="btn btn-secondary day-modal__close" type="button" data-close="1">Close</button>
                <h3 class="day-modal__title">Add a quote</h3>
                <div class="day-modal__sub">Capture the best one-liners from the day.</div>
                <label class="day-modal__label" for="quote-said-by">Who said it?</label>
                <input id="quote-said-by" class="day-modal__input" type="text" placeholder="Ursula">
                <label class="day-modal__label" for="quote-text">Quote</label>
                <textarea id="quote-text" class="day-modal__textarea" rows="4" placeholder="‚ÄúI can‚Äôt believe that worked‚Ä¶‚Äù"></textarea>
                <label class="day-modal__label" for="quote-author">Your name</label>
                <input id="quote-author" class="day-modal__input" type="text" placeholder="Leanne">
                <label class="day-modal__label" for="quote-password">Family password</label>
                <input id="quote-password" class="day-modal__input" type="password" placeholder="Family password" autocomplete="current-password">
                <div class="day-modal__actions">
                    <button class="btn btn-primary" id="btn-submit-quote" type="button">Submit quote</button>
                </div>
                <div class="day-modal__status" id="quote-status"></div>
            </div>
        </div>

        <section class="tournament-chart">
            <div class="container">
                <h2 class="section-title">
                    <span class="title-icon">üìà</span>
                    Tournament Rank Progression
                </h2>
                <p class="chart-description">Track how each player's ranking changed throughout the tournament after each round.</p>
                                  <div class="chart-container" style="width: 100%; height: 700px; position: relative;">
                      <canvas id="tournament-rank-progression-chart"></canvas>
                  </div>
            </div>
        </section>


    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div data-footer-nav></div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Ruston Family Whist Drive. 40 years of championship tradition.</p>
            </div>
        </div>
    </footer>

    <!-- Load Chart.js first -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script src="../assets/js/tournament-engine.js?v=cache3"></script>
            <script src="../assets/js/charts.js?v=20"></script>
    
    <script>
        // Global HTML escaper (used by functions outside DOMContentLoaded, e.g. photo gallery rendering).
        function escapeHtml(value) {
            return String(value ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        // Helper function to extract individual round scores for a player or partnership
        // playerCanonicalIds: either a string (single player canonical ID) or array (shared hand canonical IDs)
        function extractPlayerRoundScores(tournament, playerCanonicalIds, engine) {
            const scores = [];

            // Convert to array for consistent handling
            const searchIds = Array.isArray(playerCanonicalIds) ? playerCanonicalIds : [playerCanonicalIds];
            const isSharedHand = searchIds.length > 1;

            if (isSharedHand) {
                // Sort for consistent comparison (data layer uses alphabetical order)
                const sortedSearchIds = [...searchIds].sort();
                console.log(`üîç Searching for shared hand with canonical IDs: [${sortedSearchIds.join(', ')}]`);

                for (const round of tournament.rounds) {
                    let foundInRound = false;

                    for (const table of round.tables) {
                        if (foundInRound) break;

                        for (const partnership of table.partnerships) {
                            // partnership now has: position1 (array), position2 (array)
                            // Check if the shared hand matches EITHER position
                            const pos1Sorted = [...partnership.position1].sort();
                            const pos2Sorted = [...partnership.position2].sort();

                            // Debug first round
                            if (round.round === 1) {
                                console.log(`   Round 1: pos1=[${pos1Sorted.join(', ')}] pos2=[${pos2Sorted.join(', ')}]`);
                            }

                            // Check if our search IDs match position1
                            const matchesPos1 = sortedSearchIds.length === pos1Sorted.length &&
                                              sortedSearchIds.every((id, idx) => id === pos1Sorted[idx]);

                            // Check if our search IDs match position2
                            const matchesPos2 = sortedSearchIds.length === pos2Sorted.length &&
                                              sortedSearchIds.every((id, idx) => id === pos2Sorted[idx]);

                            if (matchesPos1 || matchesPos2) {
                                scores.push(partnership.tricks);
                                foundInRound = true;
                                console.log(`‚úÖ Found shared hand [${sortedSearchIds.join(', ')}] in round ${round.round}: ${partnership.tricks} tricks`);
                                break;
                            }
                        }
                    }
                }

                if (scores.length === 0) {
                    console.warn(`‚ö†Ô∏è No scores found for shared hand: [${sortedSearchIds.join(', ')}]`);
                }
            } else {
                // Individual player search using canonical ID
                const playerId = searchIds[0];

                for (const round of tournament.rounds) {
                    let foundInRound = false;

                    for (const table of round.tables) {
                        if (foundInRound) break;

                        for (const partnership of table.partnerships) {
                            // Check if this player's canonical ID is in either position
                            const inPos1 = partnership.position1.includes(playerId);
                            const inPos2 = partnership.position2.includes(playerId);

                            if (inPos1 || inPos2) {
                                scores.push(partnership.tricks);
                                foundInRound = true;
                                break;
                            }
                        }
                    }
                }
            }

            return scores;
        }

        // Normalize hand sharing partnership display format
        function normalizeHandSharingDisplay(playerName) {
            if (!playerName) return playerName;
            
            // Convert any hand sharing delimiter to "/" format (no spaces)
            const delimiters = ['+', '&'];
            for (const delimiter of delimiters) {
                if (playerName.includes(delimiter)) {
                    return playerName.split(delimiter).map(name => name.trim()).join('/');
                }
            }
            
            return playerName;
        }

        // Helper function to get display name using tournament engine
        function getDisplayPlayerName(tournament, playerName, tournamentEngine) {
            // Debug logging for Steve Blake shared hand issue
            if (playerName && (playerName.includes('Steve') || playerName.includes('Blake'))) {
                console.log(`üîç getDisplayPlayerName called with: "${playerName}"`);
            }
            
            if (tournamentEngine && tournamentEngine.getDisplayName) {
                const result = tournamentEngine.getDisplayName(playerName);
                
                if (playerName && (playerName.includes('Steve') || playerName.includes('Blake'))) {
                    console.log(`  ‚úÖ tournamentEngine.getDisplayName("${playerName}") -> "${result}"`);
                }
                
                return result;
            }
            // Fallback to original behavior if tournamentEngine not available
            const fallbackResult = normalizeHandSharingDisplay(playerName);
            
            if (playerName && (playerName.includes('Steve') || playerName.includes('Blake'))) {
                console.log(`  ‚ö†Ô∏è Using fallback for "${playerName}" -> "${fallbackResult}"`);
            }
            
            return fallbackResult;
        }

        function renderHeroStats(statChips) {
            const container = document.getElementById('tournament-stats');
            if (!container) return;
            container.innerHTML = '';

            const chips = Array.isArray(statChips) ? statChips.filter(chip => chip && chip.label && chip.value) : [];

            if (chips.length === 0) {
                const placeholder = document.createElement('span');
                placeholder.className = 'hero-stat hero-stat--muted';
                placeholder.textContent = 'Awaiting tournament data';
                container.appendChild(placeholder);
                return;
            }

            chips.forEach(chip => {
                const pill = document.createElement('span');
                pill.className = 'hero-stat';

                const labelEl = document.createElement('span');
                labelEl.className = 'hero-stat__label';
                labelEl.textContent = chip.label;

                const valueEl = document.createElement('span');
                valueEl.className = 'hero-stat__value';
                valueEl.textContent = chip.value;

                pill.append(labelEl, valueEl);
                container.appendChild(pill);
            });
        }

        function renderTournamentComment(commentText) {
            const commentEl = document.getElementById('tournament-comment');
            if (!commentEl) return;

            commentEl.innerHTML = '';

            if (!commentText) {
                commentEl.style.display = 'none';
                return;
            }

            const label = document.createElement('span');
            label.className = 'comment-label';
            label.textContent = 'Tournament Notes';

            const body = document.createElement('span');
            body.className = 'comment-body';
            body.textContent = `"${commentText}"`;

            commentEl.append(label, body);
            commentEl.style.display = 'block';
        }

        function formatTournamentDate(rawDate) {
            if (!rawDate) return '';
            const parsed = new Date(rawDate);
            if (!isNaN(parsed)) {
                return parsed.toLocaleDateString(undefined, {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            }
            return rawDate;
        }

        function getOrdinalWord(position) {
            const ordinals = {
                1: 'first',
                2: 'second',
                3: 'third'
            };
            if (ordinals[position]) return ordinals[position];
            const suffixes = ['th', 'st', 'nd', 'rd'];
            const value = position % 100;
            if (value >= 11 && value <= 13) {
                return `${position}th`;
            }
            const suffix = suffixes[position % 10] || 'th';
            return `${position}${suffix}`;
        }

        function formatNameList(names) {
            if (!names || names.length === 0) return '';
            if (names.length === 1) return names[0];
            if (names.length === 2) return `${names[0]} and ${names[1]}`;
            return `${names.slice(0, -1).join(', ')}, and ${names[names.length - 1]}`;
        }

        function buildTieBreakMessage(tournament, tournamentEngine) {
            if (!tournament || !Array.isArray(tournament.final_standings)) return '';
            const groupsByTricks = new Map();
            tournament.final_standings.forEach(standing => {
                const key = Number(standing.total_tricks).toFixed(3);
                if (!groupsByTricks.has(key)) {
                    groupsByTricks.set(key, []);
                }
                groupsByTricks.get(key).push(standing);
            });

            const sortedGroups = Array.from(groupsByTricks.values())
                .filter(group => group.length > 1)
                .map(group => group.sort((a, b) => a.position - b.position))
                .sort((a, b) => a[0].position - b[0].position);

            for (const group of sortedGroups) {
                const hasTieBreakValue = group.some(entry => entry.tie_break !== null && entry.tie_break !== undefined);
                if (!hasTieBreakValue) continue;

                const leader = group[0];
                // Only show tie-break messaging when it affects podium placement (1st/2nd/3rd).
                // We do not play tie-breakers for lower placings.
                if (!leader || !Number.isFinite(leader.position) || leader.position > 3) {
                    continue;
                }
                const others = group.slice(1);
                const leaderName = getDisplayPlayerName(tournament, leader.player, tournamentEngine);
                const otherNames = others.map(entry => getDisplayPlayerName(tournament, entry.player, tournamentEngine));
                const tieSize = group.length;
                const ordinalWord = getOrdinalWord(leader.position);
                const actionVerb = leader.position === 1 ? 'wins' : `comes ${ordinalWord}`;

                return `${leaderName} ${actionVerb} in a ${tieSize}-way tie break against ${formatNameList(otherNames)}.`;
            }

            return '';
        }

        function renderTieBreakMessage(tournament, tournamentEngine) {
            const messageEl = document.getElementById('tie-break-message');
            if (!messageEl) return;

            const message = buildTieBreakMessage(tournament, tournamentEngine);
            if (message) {
                messageEl.textContent = message;
                messageEl.style.display = 'block';
            } else {
                messageEl.style.display = 'none';
                messageEl.textContent = '';
            }
        }

        // Load tournament results based on URL parameter
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const year = urlParams.get('year');
            
            if (!year) {
                // Redirect to tournaments page if no year specified
                window.location.href = '../tournaments/';
                return;
            }
            
            const tournamentEngine = new TournamentEngine();
            const sheetId = '1HGfdlDOfGHOL6Q4MP_TnF8UNE6YihBW-5gQs6Ykl78k';
            
            try {
                console.log(`üèÜ Loading tournament results for ${year}...`);
                await tournamentEngine.loadFromGoogleSheets(sheetId);
                renderDataIssuesBanner(tournamentEngine.getDataIssues());
                
                // Find the tournament for the specified year
                const tournament = Array.from(tournamentEngine.tournaments.values())
                    .find(t => t.year.toString() === year);
                
                if (!tournament) {
                    document.getElementById('tournament-title').textContent = `Tournament ${year} Not Found`;
                    document.getElementById('tournament-year').textContent = year || '20XX';
                    renderHeroStats([{ label: 'Status', value: 'Tournament not found' }]);
                    renderTournamentComment('');
                    return;
                }
                
                const validationResult = validateTournamentStructure(tournament);
                if (!validationResult.valid) {
                    console.error(validationResult.error);
                    displayTournamentError(validationResult.message, year);
                    return;
                }
                
                // Update page title and meta
                document.title = `${tournament.name} (${year}) | Ruston Family Whist Drive`;
                
                // Update hero section
                document.getElementById('tournament-title').textContent = tournament.name;
                document.getElementById('tournament-year').textContent = year;
                const tournamentMetadata = tournamentEngine.getTournamentMetadata(tournament.id) 
                    || tournamentEngine.getTournamentMetadata(tournament.key);
                const tournamentComment = tournament.comments || tournamentMetadata?.comments || '';

                const championId = tournament.winner || tournament.final_standings[0]?.player || '';
                const championDisplay = championId ? getDisplayPlayerName(tournament, championId, tournamentEngine) : 'TBD';
                const stats = [
                    { label: 'Champion', value: championDisplay || 'TBD' }
                ];

                if (tournament.total_players) {
                    stats.push({ label: 'Players', value: `${tournament.total_players} players` });
                }

                if (tournament.total_rounds) {
                    stats.push({ label: 'Rounds', value: `${tournament.total_rounds} rounds` });
                }

                if (tournament.date) {
                    stats.push({ label: 'Date', value: formatTournamentDate(tournament.date) });
                }

                renderHeroStats(stats);
                renderTournamentComment(tournamentComment);

                // About the day‚Ä¶ (stories/quotes + minimal photo highlights)
                await renderAboutTheDay(year);
                
                // Generate podium-style tournament summary
                const thirdPlace = tournament.final_standings.length >= 3 ? tournament.final_standings[2] : null;
                const lastPlace = tournament.final_standings[tournament.final_standings.length - 1];
                const showBoobyPrize = tournament.final_standings.length > 3;
                
                // Helper function to get initials
                function getInitials(name) {
                    return name.split(' ').map(word => word[0]).join('');
                }

                function encodeHtml(value) {
                    return String(value ?? '')
                        .replaceAll('&', '&amp;')
                        .replaceAll('<', '&lt;')
                        .replaceAll('>', '&gt;')
                        .replaceAll('"', '&quot;')
                        .replaceAll("'", '&#39;');
                }

                // Backwards-compatible alias (some sections still call escapeHtml).
                function escapeHtml(value) {
                    return encodeHtml(value);
                }
                
                // Helper function to create player link (handles shared hands)
                function createPlayerLink(playerName, displayName, cssClass = 'player-name-link') {
                    const isSharedHand = playerName.includes('/') || playerName.includes('+') || playerName.includes('&');
                    if (isSharedHand) {
                        return `<span class="${cssClass} shared-hand">${displayName}</span>`;
                    } else {
                        return `<a href="../players/profile.html?player=${encodeURIComponent(playerName)}" class="${cssClass}">${displayName}</a>`;
                    }
                }

                function canonicalAvatarKey(playerName) {
                    const raw = String(playerName || '').trim();
                    if (!raw) return '';
                    const isSharedHand = raw.includes('/') || raw.includes('+') || raw.includes('&');
                    if (isSharedHand) return '';
                    return (tournamentEngine && typeof tournamentEngine.getCanonicalPlayerId === 'function')
                        ? tournamentEngine.getCanonicalPlayerId(raw)
                        : raw;
                }

                function sharedHandFirstInitialFromName(playerName) {
                    const raw = String(playerName || '').trim();
                    if (!raw) return '';
                    const parts = raw.split(/[\/+&]/g).map(x => String(x || '').trim()).filter(Boolean);
                    if (!parts.length) return '';

                    const ids = parts.map(p => {
                        return (tournamentEngine && typeof tournamentEngine.getCanonicalPlayerId === 'function')
                            ? tournamentEngine.getCanonicalPlayerId(p)
                            : p;
                    }).filter(Boolean);
                    if (!ids.length) return '';
                    ids.sort((a, b) => String(a).localeCompare(String(b)));

                    const firstId = ids[0];
                    const display = (tournamentEngine && typeof tournamentEngine.getDisplayName === 'function')
                        ? tournamentEngine.getDisplayName(firstId)
                        : String(firstId);
                    const ch = String(display || '').trim().charAt(0);
                    return ch ? ch.toUpperCase() : '';
                }

                function sharedHandFirstInitialFromPlayers(partnershipPlayers, fallbackName) {
                    const ids = Array.isArray(partnershipPlayers) ? partnershipPlayers.map(x => String(x || '').trim()).filter(Boolean) : [];
                    if (ids.length) {
                        ids.sort((a, b) => a.localeCompare(b));
                        const firstId = ids[0];
                        const display = (tournamentEngine && typeof tournamentEngine.getDisplayName === 'function')
                            ? tournamentEngine.getDisplayName(firstId)
                            : String(firstId);
                        const ch = String(display || '').trim().charAt(0);
                        return ch ? ch.toUpperCase() : '';
                    }
                    return sharedHandFirstInitialFromName(fallbackName);
                }

                function sharedHandAvatarHtml(partnershipPlayers, fallbackName, sizeClass) {
                    const initial = sharedHandFirstInitialFromPlayers(partnershipPlayers, fallbackName) || '?';
                    return `
                        <div class="avatar-placeholder ${sizeClass}">
                            <span class="avatar-initial">${encodeHtml(initial)}</span>
                        </div>
                    `;
                }

                function avatarHtml(playerName, displayName, sizeClass) {
                    const key = canonicalAvatarKey(playerName);
                    const raw = String(playerName || '').trim();
                    const isSharedHand = raw.includes('/') || raw.includes('+') || raw.includes('&');
                    const initials = isSharedHand
                        ? (sharedHandFirstInitialFromName(raw) || '?')
                        : getInitials(String(displayName || ''));
                    if (!key) {
                        return `
                            <div class="avatar-placeholder ${sizeClass}">
                                <span class="avatar-initial">${initials}</span>
                            </div>
                        `;
                    }
                    return `
                        <div class="avatar-placeholder ${sizeClass}">
                            <img
                                alt=""
                                loading="lazy"
                                decoding="async"
                                style="opacity:0; transition: opacity 0.15s ease;"
                                src="/media/avatars/${encodeHtml(key)}_sm.jpg"
                                onload="this.style.opacity='1'; const s=this.parentElement && this.parentElement.querySelector && this.parentElement.querySelector('.avatar-initial'); if(s) s.style.display='none';"
                                onerror="if(!this.dataset.fallback){this.dataset.fallback='1'; this.src='/media/avatars/${encodeHtml(key)}.jpg'; return;} this.style.opacity='0'; const s=this.parentElement && this.parentElement.querySelector && this.parentElement.querySelector('.avatar-initial'); if(s) s.style.display='block';"
                            >
                            <span class="avatar-initial">${initials}</span>
                        </div>
                    `;
                }
                
        const podiumHTML = `
                    <div class="spacer-left"></div>
                    <div class="podium-places">
                        <div class="podium-place second">
                            <div class="podium-player">
                                <div class="podium-avatar">
                                    ${avatarHtml(tournament.final_standings[1].player, getDisplayPlayerName(tournament, tournament.final_standings[1].player, tournamentEngine), 'small')}
                                </div>
                                <h3 class="podium-name">
                                    ${createPlayerLink(tournament.final_standings[1].player, getDisplayPlayerName(tournament, tournament.final_standings[1].player, tournamentEngine), 'player-name-link')}
                                </h3>
                                <div class="podium-score">${tournament.final_standings[1].total_tricks} tricks</div>
                            </div>
                            <div class="podium-base second-place">
                                <div class="podium-medal">ü•à</div>
                                <div class="podium-rank">2nd</div>
                            </div>
                        </div>
                        
                        <div class="podium-place first">
                            <div class="podium-player">
                                <div class="podium-avatar">
                                    ${avatarHtml(tournament.final_standings[0].player, getDisplayPlayerName(tournament, tournament.final_standings[0].player, tournamentEngine), 'large')}
                                    <div class="champion-crown">üëë</div>
                                </div>
                                <h3 class="podium-name">
                                    ${createPlayerLink(tournament.final_standings[0].player, getDisplayPlayerName(tournament, tournament.final_standings[0].player, tournamentEngine), 'player-name-link')}
                                </h3>
                                <div class="podium-score">${tournament.final_standings[0].total_tricks} tricks</div>
                            </div>
                            <div class="podium-base first-place">
                                <div class="podium-medal">ü•á</div>
                                <div class="podium-rank">1st</div>
                            </div>
                        </div>
                        
                        ${thirdPlace ? `
                        <div class="podium-place third">
                            <div class="podium-player">
                                <div class="podium-avatar">
                                    ${avatarHtml(thirdPlace.player, getDisplayPlayerName(tournament, thirdPlace.player, tournamentEngine), 'small')}
                                </div>
                                <h3 class="podium-name">
                                    ${createPlayerLink(thirdPlace.player, getDisplayPlayerName(tournament, thirdPlace.player, tournamentEngine), 'player-name-link')}
                                </h3>
                                <div class="podium-score">${thirdPlace.total_tricks} tricks</div>
                            </div>
                            <div class="podium-base third-place">
                                <div class="podium-medal">ü•â</div>
                                <div class="podium-rank">3rd</div>
                            </div>
                        </div>
                        ` : ''}
                        
                    </div>
                    ${showBoobyPrize ? `
                    <div class="booby-prize-container">
                        <div class="podium-place booby">
                            <div class="podium-player">
                                <div class="podium-avatar">
                                    ${avatarHtml(lastPlace.player, getDisplayPlayerName(tournament, lastPlace.player, tournamentEngine), 'tiny')}
                                </div>
                                <h3 class="podium-name">
                                    ${createPlayerLink(lastPlace.player, getDisplayPlayerName(tournament, lastPlace.player, tournamentEngine), 'player-name-link')}
                                </h3>
                                <div class="podium-score">${lastPlace.total_tricks} tricks</div>
                                <div class="booby-badge">
                                    <span class="booby-emoji">üé≠</span>
                                    <span class="booby-text">Booby Prize</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                `;
                document.getElementById('summary-grid').innerHTML = podiumHTML;
                renderTieBreakMessage(tournament, tournamentEngine);
                
                // Debug: Check what's actually in final standings
                console.log('üîç Tournament final standings - ALL ENTRIES:');
                tournament.final_standings.forEach((standing, index) => {
                    console.log(`  ${index + 1}. standing.player: "${standing.player}" (${standing.total_tricks} tricks)`);
                    if (standing.player.includes('Steve') || standing.player.includes('Blake')) {
                        console.log(`     *** STEVE/BLAKE ENTRY: getDisplayPlayerName result: "${getDisplayPlayerName(tournament, standing.player, tournamentEngine)}"`);
                    }
                });
                
                // Generate rankings table
                const rankingsHTML = tournament.final_standings.map((player, index) => {
                    const playerStats = tournamentEngine.getPlayerStats(player.player);

                    // Determine canonical IDs to search for
                    // If this is a shared hand partnership, use the partnership_players array
                    // Otherwise, use the player's canonical ID
                    let searchIds;
                    if (player.is_partnership && player.partnership_players) {
                        searchIds = player.partnership_players; // Array of canonical IDs, already sorted alphabetically
                        console.log(`üîç DEBUG: Partnership "${player.player}" uses canonical IDs:`, searchIds);
                    } else {
                        searchIds = player.player; // Single canonical ID
                    }

                    // Extract individual round scores from tournament rounds data
                    const roundScores = extractPlayerRoundScores(tournament, searchIds, tournamentEngine);
                    console.log(`üìä Player: "${player.player}" - Scores: [${roundScores.join(', ')}]`);
                    const bestScore = roundScores.length > 0 ? Math.max(...roundScores) : 0;
                    const worstScore = roundScores.length > 0 ? Math.min(...roundScores) : 0;
                    const roundsWon = roundScores.filter(score => score >= 7).length;
                    
                    // Count occurrences of best and worst scores
                    const bestScoreCount = roundScores.filter(score => score === bestScore).length;
                    const worstScoreCount = roundScores.filter(score => score === worstScore).length;
                    
                    // Format with occurrence counts
                    const bestScoreDisplay = bestScore + (bestScoreCount > 1 ? ` <span class="score-count">(x${bestScoreCount})</span>` : '');
                    const worstScoreDisplay = worstScore + (worstScoreCount > 1 ? ` <span class="score-count">(x${worstScoreCount})</span>` : '');
                    const isLastPlace = index === tournament.final_standings.length - 1;
                    
                    let rowClass = '';
                    if (index === 0) {
                        rowClass = 'podium-row first-place';
                    } else if (index === 1) {
                        rowClass = 'podium-row second-place';
                    } else if (index === 2) {
                        rowClass = 'podium-row third-place';
                    } else if (isLastPlace && tournament.final_standings.length > 3) {
                        rowClass = 'booby-row';
                    }
                    
                    return `
                        <tr class="${rowClass}">
                            <td class="rank-cell">
                                <span class="rank-number">${index + 1}</span>
                                ${index === 0 ? '<span class="medal">ü•á</span>' : ''}
                                ${index === 1 ? '<span class="medal">ü•à</span>' : ''}
                                ${index === 2 ? '<span class="medal">ü•â</span>' : ''}
                                ${isLastPlace && tournament.final_standings.length > 3 ? '<span class="medal">üé≠</span>' : ''}
                            </td>
                            <td class="player-cell">
                                ${player.player.includes('/') || player.player.includes('+') || player.player.includes('&')
                                    ? `
                                        <span class="player-cell__wrap">
                                            ${sharedHandAvatarHtml(player.partnership_players, player.player, 'table')}
                                        <strong>${getDisplayPlayerName(tournament, player.player, tournamentEngine)}</strong>
                                        </span>
                                    `
                                    : `
                                        <span class="player-cell__wrap">
                                            ${avatarHtml(player.player, getDisplayPlayerName(tournament, player.player, tournamentEngine), 'table')}
                                            <a href="../players/profile.html?player=${encodeURIComponent(player.player)}" class="player-name-link">
                                                <strong>${getDisplayPlayerName(tournament, player.player, tournamentEngine)}</strong>
                                            </a>
                                        </span>
                                    `
                                }
                            </td>
                            <td class="tricks-cell">${player.total_tricks}</td>
                            <td>${(player.total_tricks / tournament.total_rounds).toFixed(2)}</td>
                            <td class="best-round">${bestScoreDisplay}</td>
                            <td class="worst-round">${worstScoreDisplay}</td>
                            <td>${roundsWon}</td>
                            <td>
                                <a href="scorecard.html?year=${year}&player=${encodeURIComponent(player.is_partnership && player.partnership_players ? player.partnership_players.join('/') : player.player)}" 
                                   class="scorecard-btn">See Scorecard</a>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('rankings-tbody').innerHTML = rankingsHTML;
                

                
                // Create tournament rank progression chart
                createTournamentRankChart(tournament, tournamentEngine);
                
                console.log(`‚úÖ Tournament results for ${year} loaded successfully!`);
                
            } catch (error) {
                console.error('‚ùå Error loading tournament results:', error);
                const issuesSummary = typeof tournamentEngine?.getDataIssues === 'function'
                    ? tournamentEngine.getDataIssues()
                    : null;
                renderDataIssuesBanner(issuesSummary);

                const criticalIssue = issuesSummary?.issues?.find(issue => issue.severity === 'error');
                const errorMessage = criticalIssue?.message || error?.message || 'Unable to load tournament data.';
                displayTournamentError(errorMessage, year);
            }
        });

        function openDayModal(modalEl) {
            if (!modalEl) return;
            modalEl.style.display = 'block';
            modalEl.setAttribute('aria-hidden', 'false');
        }

        function closeDayModal(modalEl) {
            if (!modalEl) return;
            modalEl.style.display = 'none';
            modalEl.setAttribute('aria-hidden', 'true');
        }

        async function ensureFamilyAuth(password) {
            const pw = String(password || '').trim();
            if (pw) {
                const res = await fetch('/api/family/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pw })
                });
                return res.ok;
            }
            try {
                const res = await fetch('/api/family/status', { cache: 'no-store' });
                return res.ok;
            } catch (_) {
                return false;
            }
        }

        function fmtDate(iso) {
            const s = String(iso || '').trim();
            if (!s) return '';
            const d = new Date(s);
            if (!Number.isFinite(d.getTime())) return '';
            return d.toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        }

        async function fetchDayNotes(year) {
            const y = String(year || '').trim();
            if (!/^\d{4}$/.test(y)) return { stories: [], quotes: [] };
            const res = await fetch(`/api/day-notes?year=${encodeURIComponent(y)}`, { cache: 'no-store' });
            if (!res.ok) return { stories: [], quotes: [] };
            const json = await res.json().catch(() => ({}));
            return {
                stories: Array.isArray(json?.stories) ? json.stories : [],
                quotes: Array.isArray(json?.quotes) ? json.quotes : []
            };
        }

        function renderDayNotesInto(el, { stories = [], quotes = [] } = {}) {
            if (!el) return;
                const items = [];
            for (const s of (stories || [])) {
                items.push({ type: 'story', id: s?.id, text: s?.text, author: s?.author, createdAt: s?.createdAt });
            }
            for (const q of (quotes || [])) {
                items.push({ type: 'quote', id: q?.id, text: q?.text, author: q?.author, saidBy: q?.saidBy, createdAt: q?.createdAt });
            }
            items.sort((a, b) => String(b.createdAt || '').localeCompare(String(a.createdAt || '')));

            if (!items.length) {
                el.innerHTML = `<div class="day-empty">No stories or quotes yet ‚Äî add one above.</div>`;
                return;
            }

            el.innerHTML = items.map(item => {
                if (item.type === 'quote') {
                    const saidBy = String(item.saidBy || '').trim();
                    const author = String(item.author || '').trim();
                    const metaBits = [];
                    if (saidBy) metaBits.push(`Said by <strong>${escapeHtml(saidBy)}</strong>`);
                    if (author) metaBits.push(`Added by <strong>${escapeHtml(author)}</strong>`);
                    const when = fmtDate(item.createdAt);
                    if (when) metaBits.push(escapeHtml(when));
                    return `
                        <div class="day-note">
                            <div class="day-note__kicker">üí¨ Quote</div>
                            <div class="day-note__body">${escapeHtml(String(item.text || '').trim())}</div>
                            <div class="day-note__meta">${metaBits.join(' ‚Ä¢ ')}</div>
                        </div>
                    `;
                }
                const author = String(item.author || '').trim();
                const metaBits = [];
                if (author) metaBits.push(`By <strong>${escapeHtml(author)}</strong>`);
                const when = fmtDate(item.createdAt);
                if (when) metaBits.push(escapeHtml(when));
                return `
                    <div class="day-note">
                        <div class="day-note__kicker">üìñ Story</div>
                        <div class="day-note__body">${escapeHtml(String(item.text || '').trim())}</div>
                        <div class="day-note__meta">${metaBits.join(' ‚Ä¢ ')}</div>
                    </div>
                `;
            }).join('');
        }

        async function renderPhotoHighlights(year) {
            const section = document.getElementById('tournament-photos');
            const row = document.getElementById('day-photo-row');
            const empty = document.getElementById('day-photo-empty');
            const btnAddPhotos = document.getElementById('btn-add-photos');
            const btnSee = document.getElementById('btn-see-gallery');
            if (!section || !row || !empty || !btnAddPhotos || !btnSee) return;

            const y = String(year || '').trim();
            btnAddPhotos.href = `../upload/tournament-photos.html?year=${encodeURIComponent(y)}`;
            btnAddPhotos.style.display = 'inline-flex';
            btnSee.href = `photos.html?year=${encodeURIComponent(y)}`;
            btnSee.style.display = 'none';

            if (!(window.WhistMedia && typeof window.WhistMedia.getTournamentMeta === 'function')) {
                empty.style.display = 'block';
                empty.textContent = 'Photo highlights not available.';
                return;
            }
            if (!(window.WhistMedia && typeof window.WhistMedia.publicUrlForKey === 'function')) {
                empty.style.display = 'block';
                empty.textContent = 'Photo highlights not available.';
                return;
            }

            const meta = await window.WhistMedia.getTournamentMeta(y);
            const photos = Array.isArray(meta?.photos) ? meta.photos.slice() : [];
            const coverPicks = Array.isArray(meta?.coverPicks) ? meta.coverPicks.slice(0, 6) : [];

            const byKey = new Map();
            for (const p of photos) {
                if (!p || !p.key) continue;
                byKey.set(String(p.key), p);
            }

            // 1) Highlights row: prefer up to 6 cover picks; if fewer, fill with most recent uploads.
            const highlights = [];
            const highlightSet = new Set();
            for (const key of coverPicks) {
                const k = String(key || '');
                if (!k || highlightSet.has(k)) continue;
                highlightSet.add(k);
                highlights.push(k);
                if (highlights.length >= 6) break;
            }
            const newestFirst = photos.slice().sort((a, b) => String(b?.uploadedAt || '').localeCompare(String(a?.uploadedAt || '')));
            for (const p of newestFirst) {
                if (highlights.length >= 6) break;
                const k = String(p?.key || '');
                if (!k || highlightSet.has(k)) continue;
                highlightSet.add(k);
                highlights.push(k);
            }

            if (!highlights.length) {
                row.innerHTML = '';
                empty.style.display = 'block';
                empty.innerHTML = `No photos yet. <a style="color: inherit; font-weight: 900; text-decoration: underline;" href="${btnAddPhotos.href.replaceAll('"', '&quot;')}">Add photos ‚Üí</a>`;
                btnSee.style.display = 'none';
                return;
            }

            // 2) Lightbox sequence: cover/highlights first, then the rest of the album (oldest ‚Üí newest),
            // skipping anything already shown in highlights.
            const oldestFirst = photos.slice().sort((a, b) => {
                const da = String(a?.uploadedAt || '');
                const db = String(b?.uploadedAt || '');
                const t = da.localeCompare(db);
                if (t !== 0) return t;
                return String(a?.key || '').localeCompare(String(b?.key || ''));
            });
            const restKeys = [];
            for (const p of oldestFirst) {
                const k = String(p?.key || '');
                if (!k || highlightSet.has(k)) continue;
                restKeys.push(k);
            }
            const sequenceKeys = highlights.concat(restKeys);

            const buildCaption = (entry, key) => {
                const uploader = String(entry?.uploaderName || entry?.uploaderSlug || '').trim();
                const parts = [];
                if (uploader) parts.push(`Uploader: ${uploader}`);
                if (key) parts.push(`Key: ${key}`);
                return parts.join(' ‚Ä¢ ');
            };

            const lightboxItems = [];
            for (const k of sequenceKeys) {
                const fullUrl = await window.WhistMedia.publicUrlForKey(k);
                if (!fullUrl) continue;
                const entry = byKey.get(k);
                const thumbKey = String(entry?.thumbKey || '').trim();
                const thumbUrl = thumbKey ? await window.WhistMedia.publicUrlForKey(thumbKey) : '';
                lightboxItems.push({ url: fullUrl, thumbUrl: thumbUrl || '', caption: buildCaption(entry, k) });
            }

            const cells = [];
            for (let i = 0; i < highlights.length && cells.length < 6; i++) {
                const k = highlights[i];
                const entry = byKey.get(k);
                const fullUrl = await window.WhistMedia.publicUrlForKey(k);
                if (!fullUrl) continue;
                const thumbKey = String(entry?.thumbKey || '').trim();
                const thumbUrl = thumbKey ? await window.WhistMedia.publicUrlForKey(thumbKey) : '';
                const imgUrl = thumbUrl || fullUrl;
                const uploader = String(entry?.uploaderName || entry?.uploaderSlug || '').trim();
                const filename = String(entry?.originalName || '').trim() || String(k).split('/').pop();
                cells.push(
                    `<a href="${fullUrl.replaceAll('"', '&quot;')}" data-index="${i}" rel="noopener" data-uploader="${escapeHtml(uploader)}" data-filename="${escapeHtml(filename)}" data-key="${escapeHtml(String(k))}"><img alt="Tournament photo" loading="lazy" src="${imgUrl.replaceAll('"', '&quot;')}"></a>`
                );
            }

            row.innerHTML = cells.join('');
            empty.style.display = 'none';
            empty.innerHTML = '';
            btnSee.style.display = 'inline-flex';

            if (window.WhistLightbox && typeof window.WhistLightbox.open === 'function') {
                const goToHref = btnSee.href;
                const goToLabel = /^\d{4}$/.test(y) ? `Go to ${y} gallery` : 'Go to gallery';
                row.querySelectorAll('a[data-index]').forEach(a => {
                    a.addEventListener('click', (e) => {
                        if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;
                        e.preventDefault();
                        const start = Number(a.getAttribute('data-index') || '0') || 0;
                        window.WhistLightbox.open(lightboxItems, start, { goToHref, goToLabel });
                    });
                });
            }
        }

        async function renderAboutTheDay(year) {
            const section = document.getElementById('tournament-photos');
            const notesEl = document.getElementById('day-notes');
            const btnStory = document.getElementById('btn-add-story');
            const btnQuote = document.getElementById('btn-add-quote');
            const modalStory = document.getElementById('modal-story');
            const modalQuote = document.getElementById('modal-quote');
            if (!section || !notesEl || !btnStory || !btnQuote || !modalStory || !modalQuote) return;

            section.style.display = 'block';

            const y = String(year || '').trim();
            await renderPhotoHighlights(y);

            const refresh = async () => {
                const data = await fetchDayNotes(y);
                renderDayNotesInto(notesEl, data);
            };
            await refresh();

            // Modal close handlers (backdrop + close button)
            [modalStory, modalQuote].forEach(m => {
                m.addEventListener('click', (e) => {
                    const t = e.target;
                    if (t && t.getAttribute && t.getAttribute('data-close') === '1') {
                        closeDayModal(m);
                    }
                });
            });

            btnStory.addEventListener('click', () => openDayModal(modalStory));
            btnQuote.addEventListener('click', () => openDayModal(modalQuote));

            const setStatus = (el, msg) => { if (el) el.textContent = String(msg || ''); };

            const submitStoryBtn = document.getElementById('btn-submit-story');
            const submitQuoteBtn = document.getElementById('btn-submit-quote');

            if (submitStoryBtn) {
                submitStoryBtn.addEventListener('click', async () => {
                    const author = String(document.getElementById('story-author')?.value || '').trim();
                    const text = String(document.getElementById('story-text')?.value || '').trim();
                    const pw = String(document.getElementById('story-password')?.value || '').trim();
                    const statusEl = document.getElementById('story-status');
                    setStatus(statusEl, '');
                    if (!author) return setStatus(statusEl, 'Please enter your name.');
                    if (text.length < 5) return setStatus(statusEl, 'Please write a longer story.');
                    if (!pw) return setStatus(statusEl, 'Family password required.');
                    const res = await fetch(`/api/day-notes?year=${encodeURIComponent(y)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ year: y, type: 'story', author, text, password: pw })
                    });
                    const json = await res.json().catch(() => ({}));
                    if (!res.ok) {
                        const msg = String(json?.error || '').toLowerCase() === 'unauthorized'
                            ? 'Incorrect family password.'
                            : (json?.error || `Submit failed (${res.status})`);
                        return setStatus(statusEl, msg);
                    }
                    document.getElementById('story-text').value = '';
                    document.getElementById('story-password').value = '';
                    closeDayModal(modalStory);
                    await refresh();
                });
            }

            if (submitQuoteBtn) {
                submitQuoteBtn.addEventListener('click', async () => {
                    const saidBy = String(document.getElementById('quote-said-by')?.value || '').trim();
                    const text = String(document.getElementById('quote-text')?.value || '').trim();
                    const author = String(document.getElementById('quote-author')?.value || '').trim();
                    const pw = String(document.getElementById('quote-password')?.value || '').trim();
                    const statusEl = document.getElementById('quote-status');
                    setStatus(statusEl, '');
                    if (!saidBy) return setStatus(statusEl, 'Please enter who said it.');
                    if (text.length < 2) return setStatus(statusEl, 'Please enter a quote.');
                    if (!author) return setStatus(statusEl, 'Please enter your name.');
                    if (!pw) return setStatus(statusEl, 'Family password required.');
                    const res = await fetch(`/api/day-notes?year=${encodeURIComponent(y)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ year: y, type: 'quote', author, saidBy, text, password: pw })
                    });
                    const json = await res.json().catch(() => ({}));
                    if (!res.ok) {
                        const msg = String(json?.error || '').toLowerCase() === 'unauthorized'
                            ? 'Incorrect family password.'
                            : (json?.error || `Submit failed (${res.status})`);
                        return setStatus(statusEl, msg);
                    }
                    document.getElementById('quote-text').value = '';
                    document.getElementById('quote-password').value = '';
                    closeDayModal(modalQuote);
                    await refresh();
                });
            }
        }

        function createTournamentRankChart(tournament, tournamentEngine) {
            try {
                // Initialize charts instance
                const charts = new TournamentCharts();
                
                // Create the rank progression chart without player highlighting (show all players)
                charts.createRankProgressChart('tournament-rank-progression-chart', tournament, null, tournamentEngine);
                
                console.log(`üìà Created tournament rank progression chart for ${tournament.year}`);
            } catch (error) {
                console.error('Error creating tournament rank progression chart:', error);
                // Hide the chart section if there's an error
                const chartSection = document.querySelector('.tournament-chart');
                if (chartSection) {
                    chartSection.style.display = 'none';
                }
            }
        }
        
        const TRICK_WARNING_STORAGE_KEY = 'whist_hide_trick_mismatch_warning';

        function shouldDisplayTrickWarnings() {
            if (typeof window !== 'undefined' && window.TournamentUIConfig && window.TournamentUIConfig.showTrickImbalanceWarnings === false) {
                return false;
            }
            if (typeof window === 'undefined' || typeof window.localStorage === 'undefined') {
                return true;
            }
            try {
                return localStorage.getItem(TRICK_WARNING_STORAGE_KEY) !== 'true';
            } catch (error) {
                console.warn('Unable to read trick warning preference from localStorage:', error);
                return true;
            }
        }

        function summarizeTrickMismatchIssues(issues) {
            const tableMap = new Map();
            const roundSet = new Set();

            issues.forEach(issue => {
                const tournamentLabel = issue.tournament || issue.tournamentId || (issue.year ? `Year ${issue.year}` : 'Tournament');
                const roundLabel = typeof issue.round === 'number' ? issue.round : 'Unknown';
                const tableLabel = typeof issue.table === 'number' ? issue.table : 'Unknown';
                const roundKey = `${tournamentLabel}::${roundLabel}`;
                const tableKey = `${roundKey}::${tableLabel}`;

                roundSet.add(roundKey);
                if (!tableMap.has(tableKey)) {
                    tableMap.set(tableKey, {
                        tournament: tournamentLabel,
                        round: roundLabel,
                        table: tableLabel,
                        total: Number.isFinite(issue.actual) ? issue.actual : issue.actual || 'Unknown'
                    });
                }
            });

            return {
                totalRounds: roundSet.size,
                totalTables: tableMap.size,
                samples: Array.from(tableMap.values())
            };
        }

        function attachTrickWarningDismissHandler(banner) {
            const dismissButton = banner.querySelector('[data-dismiss-trick-warning]');
            if (!dismissButton) {
                return;
            }

            dismissButton.addEventListener('click', () => {
                try {
                    localStorage.setItem(TRICK_WARNING_STORAGE_KEY, 'true');
                } catch (error) {
                    console.warn('Unable to persist trick warning preference:', error);
                }

                const warningBlock = banner.querySelector('.data-issues-banner__warning');
                if (warningBlock) {
                    warningBlock.remove();
                }

                const hasErrors = banner.querySelector('.data-issues-banner__errors');
                if (!hasErrors) {
                    banner.style.display = 'none';
                    banner.innerHTML = '';
                }
            }, { once: true });
        }

        function renderDataIssuesBanner(dataIssuesSummary) {
            const banner = document.getElementById('data-issues-banner');
            if (!banner || !dataIssuesSummary || !Array.isArray(dataIssuesSummary.issues)) {
                return;
            }
            
            const issues = dataIssuesSummary.issues;
            const errorIssues = issues.filter(issue => issue.severity === 'error');
            const trickWarnings = shouldDisplayTrickWarnings()
                ? issues.filter(issue => issue.type === 'trick_count_mismatch')
                : [];
            
            if (errorIssues.length === 0 && trickWarnings.length === 0) {
                banner.style.display = 'none';
                banner.innerHTML = '';
                return;
            }
            
            let bannerSections = '';
            
            if (errorIssues.length > 0) {
                const issueList = errorIssues.map(issue => {
                    const location = issue.sheet ? `${issue.sheet}${issue.row ? ` (Row ${issue.row})` : ''}` : '';
                    const message = issue.message || issue.details || 'An unknown parsing error occurred.';
                    return `<li>${location ? `<strong>${location}:</strong> ` : ''}${message}</li>`;
                }).join('');
                
                bannerSections += `
                    <div class="data-issues-banner__errors">
                        <strong>Data Import Errors Detected</strong>
                        <ul>${issueList}</ul>
                    </div>
                `;
            }
            
            if (trickWarnings.length > 0) {
                const summary = summarizeTrickMismatchIssues(trickWarnings);
                const warningItems = summary.samples.slice(0, 3).map(entry => {
                    return `<li>${entry.tournament} ¬∑ Round ${entry.round}, Table ${entry.table} (reported total: ${entry.total})</li>`;
                }).join('');
                
                bannerSections += `
                    <div class="data-issues-banner__warning">
                        <div class="data-issues-banner__warning-header">
                            <strong>Trick totals look unbalanced</strong>
                            <span class="data-issues-banner__pill">${summary.totalTables} table${summary.totalTables === 1 ? '' : 's'}</span>
                            <span class="data-issues-banner__pill">${summary.totalRounds} round${summary.totalRounds === 1 ? '' : 's'}</span>
                        </div>
                        <p>Each table should total 13 tricks. Historical data currently shows ${summary.totalTables} table${summary.totalTables === 1 ? '' : 's'} across ${summary.totalRounds} round${summary.totalRounds === 1 ? '' : 's'} where the totals differ.</p>
                        ${warningItems ? `<ul class="data-issues-banner__warning-list">${warningItems}</ul>` : ''}
                        <button type="button" class="data-issues-banner__dismiss" data-dismiss-trick-warning>
                            Hide trick mismatch warning
                        </button>
                    </div>
                `;
            }
            
            banner.innerHTML = `<div class="data-issues-banner__content">${bannerSections}</div>`;
            banner.style.display = 'block';
            attachTrickWarningDismissHandler(banner);
        }
        
        function validateTournamentStructure(tournament) {
            if (!tournament || !Array.isArray(tournament.rounds)) {
                return { valid: false, error: new Error('Tournament rounds data missing'), message: 'Tournament data is unavailable.' };
            }
            
            for (const round of tournament.rounds) {
                if (!round.tables || round.tables.length === 0) {
                    return {
                        valid: false,
                        error: new Error(`Round ${round.round} has no tables defined.`),
                        message: `Round ${round.round} is missing table data.`
                    };
                }
                
                const invalidTable = round.tables.find(table => !table.partnerships || table.partnerships.length === 0);
                if (invalidTable) {
                    return {
                        valid: false,
                        error: new Error(`Round ${round.round} table ${invalidTable.table || '?'} has no partnerships defined.`),
                        message: `Round ${round.round} table data is incomplete.`
                    };
                }
            }
            
            return { valid: true };
        }
        
        function displayTournamentError(message, year) {
            document.getElementById('tournament-title').textContent = 'Tournament Data Error';
            document.getElementById('tournament-year').textContent = year || '‚Äî';
            renderHeroStats([{ label: 'Data Integrity', value: message || 'Display unavailable' }]);
            renderTournamentComment('');
            
            const sections = document.querySelectorAll('.tournament-summary, .tournament-rankings, .tournament-chart');
            sections.forEach(section => {
                if (section) {
                    section.style.display = 'none';
                }
            });
        }
    </script>
    
    <style>
        /* Tournament Results Specific Styles */
        .tournament-hero {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--primary-dark) 100%);
            color: var(--text-primary);
            padding: var(--spacing-3xl) 0;
        }

        .tournament-hero .hero-comment {
            margin-top: var(--spacing-md);
            font-size: 1rem;
            color: var(--text-primary);
            max-width: 720px;
            margin-left: auto;
            margin-right: auto;
        }

        .tournament-summary {
            padding: var(--spacing-2xl) 0;
            background: var(--bg-primary);
        }

        .summary-grid {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: var(--spacing-lg) 0;
            max-width: 900px;
            margin: 0 auto;
        }

        .tie-break-message {
            margin-top: var(--spacing-md);
            text-align: center;
            font-style: italic;
            color: rgba(255, 255, 255, 0.85);
            font-size: 1rem;
        }

        .spacer-left {
            width: 120px; /* Match booby container width for balance */
            flex-shrink: 0;
        }

        .booby-prize-container {
            width: 120px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            flex-shrink: 0;
        }

        /* Podium Styles */
        .podium-places {
            display: flex;
            align-items: end;
            gap: var(--spacing-xl);
        }

        .podium-place {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .podium-player {
            margin-bottom: var(--spacing-lg);
        }

        .podium-avatar {
            position: relative;
            margin-bottom: var(--spacing-md);
        }

        .avatar-placeholder {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-family: var(--font-primary);
            overflow: hidden;
            position: relative;
        }

        .avatar-placeholder img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .avatar-placeholder.large {
            width: 100px;
            height: 100px;
            font-size: 1.5rem;
        }

        .avatar-placeholder.small {
            width: 80px;
            height: 80px;
            font-size: 1.25rem;
        }

        .avatar-placeholder.tiny {
            width: 60px;
            height: 60px;
            font-size: 1rem;
        }

        .avatar-placeholder.table {
            width: 36px;
            height: 36px;
            font-size: 0.95rem;
        }

        .player-cell__wrap {
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
        }

        .champion-crown {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
        }

        .podium-name {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
        }

        .booby-badge {
            height: 60px; /* Match third place podium height */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 0; /* Remove margin to align with podium bases */
            text-align: center;
        }

        .booby-emoji {
            font-size: 1.5rem;
            margin-bottom: var(--spacing-xs);
        }

        .booby-text {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        /* Ensure booby place is perfectly centered */
        .podium-place.booby {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        /* Center the booby prize avatar specifically */
        .podium-place.booby .podium-avatar {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        /* Remove bottom margin for booby player to align badge with podium bases */
        .podium-place.booby .podium-player {
            margin-bottom: 0;
        }

        .podium-score {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .podium-base {
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            width: 100px;
            position: relative;
        }

        .podium-base.first-place {
            height: 100px;
            background: linear-gradient(135deg, var(--gold) 0%, #f59e0b 100%);
        }

        .podium-base.second-place {
            height: 80px;
            background: linear-gradient(135deg, var(--silver) 0%, #9ca3af 100%);
        }

        .podium-base.third-place {
            height: 60px;
            background: linear-gradient(135deg, var(--bronze) 0%, #92400e 100%);
        }



        .podium-medal {
            font-size: 1.5rem;
            margin-bottom: var(--spacing-xs);
        }

        .podium-rank {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tournament-rankings {
            padding: var(--spacing-3xl) 0;
            background: var(--bg-primary);
        }

        .rankings-table-container {
            overflow-x: auto;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
        }

        .rankings-table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            color: #1f2937; /* Ensure all table text is dark */
        }

        .rankings-table th {
            background: var(--primary-dark);
            color: white;
            padding: var(--spacing-md);
            text-align: left;
            font-weight: 600;
        }

        .rankings-table td {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
            color: #1f2937; /* Ensure dark text on white background */
        }

        .podium-row {
            background: linear-gradient(135deg, #fef3c7 0%, #fff 100%);
        }

        .podium-row.first-place {
            border-left: 4px solid #fbbf24; /* Gold */
        }

        .podium-row.second-place {
            border-left: 4px solid #94a3b8; /* Silver */
        }

        .podium-row.third-place {
            border-left: 4px solid #d97706; /* Bronze */
        }

        .booby-row {
            background: linear-gradient(135deg, #fef2f2 0%, #fff 100%);
            border-left: 4px solid #dc2626;
        }

        .rank-cell {
            text-align: center;
        }

        /* Player name link styles */
        .player-name-link {
            color: inherit;
            text-decoration: none;
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 2px 4px;
            margin: -2px -4px;
        }

        .player-name-link:hover {
            color: var(--primary-color);
            background-color: rgba(79, 70, 229, 0.1);
            text-decoration: none;
        }

        /* Special styling for podium names */
        .podium-name .player-name-link {
            color: inherit;
            font-weight: inherit;
            text-decoration: none;
        }

        .podium-name .player-name-link:hover {
            color: var(--primary);
            background-color: rgba(79, 70, 229, 0.1);
            text-decoration: none;
        }

        /* Round winner link styling */
        .round-winner .player-name-link {
            color: var(--primary-color);
            font-weight: 600;
        }

        .round-winner .player-name-link:hover {
            color: var(--accent-color);
            background-color: rgba(79, 70, 229, 0.1);
        }

        .rank-number {
            font-weight: 700;
            color: #1f2937; /* Ensure rank numbers are dark */
        }

        .player-cell strong {
            color: #1f2937; /* Ensure player names are dark */
        }

        .tricks-cell, .best-round, .worst-round {
            color: #1f2937; /* Ensure numeric values are dark */
            font-weight: 600;
        }

        .medal {
            margin-left: var(--spacing-sm);
        }

        .scorecard-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #2563eb 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-block;
            white-space: nowrap;
            box-shadow: 0 3px 6px rgba(79, 70, 229, 0.3);
            border: none;
            min-width: 90px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .scorecard-btn:hover {
            background: linear-gradient(135deg, #3730a3 0%, #6b21a8 50%, #1d4ed8 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(79, 70, 229, 0.4);
        }

        .scorecard-btn:active {
            transform: translateY(0);
            transition: all 0.1s ease;
        }

        .score-count {
            font-size: 0.75rem;
            color: #6b7280; /* Lighter gray color */
            font-weight: 400;
        }

        .tournament-chart {
            padding: var(--spacing-3xl) 0;
            background: var(--bg-primary);
        }

        .chart-description {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.88);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.35);
            margin-bottom: var(--spacing-xl);
            text-align: center;
        }

        .chart-container {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            position: relative;
            height: 500px;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        .data-issues-banner {
            background: #fee2e2;
            border: 1px solid #dc2626;
            color: #7f1d1d;
            padding: 1rem 1.5rem;
            margin: 0;
            text-align: left;
        }
        
        .data-issues-banner__content ul {
            margin: 0.5rem 0 0 1rem;
            padding: 0;
        }

        .data-issues-banner__errors + .data-issues-banner__warning {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(124, 45, 18, 0.25);
        }

        .data-issues-banner__warning {
            color: #7f1d1d;
        }

        .data-issues-banner__warning-header {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.35rem;
        }

        .data-issues-banner__pill {
            background: rgba(127, 29, 29, 0.1);
            border: 1px solid rgba(127, 29, 29, 0.3);
            border-radius: 999px;
            padding: 0.1rem 0.75rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .data-issues-banner__warning-list {
            margin: 0.35rem 0 0.35rem 1.25rem;
            padding-left: 0;
        }

        .data-issues-banner__warning-list li {
            margin-bottom: 0.25rem;
        }

        .data-issues-banner__dismiss {
            background: rgba(185, 28, 28, 0.1);
            border: 1px solid rgba(185, 28, 28, 0.4);
            border-radius: 999px;
            color: inherit;
            padding: 0.35rem 0.9rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .data-issues-banner__dismiss:hover {
            background: rgba(185, 28, 28, 0.2);
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .rankings-table {
                font-size: 0.875rem;
            }

            /* Mobile podium styles */
            .summary-grid {
                flex-direction: column;
                align-items: center;
                gap: var(--spacing-xl);
                justify-content: center;
            }

            .spacer-left {
                display: none; /* Hide spacer on mobile */
            }

            .podium-places {
                gap: var(--spacing-md);
                flex-wrap: wrap;
                justify-content: center;
            }

            .booby-prize-container {
                width: auto;
                margin-top: var(--spacing-lg);
            }

            .avatar-placeholder.large {
                width: 80px;
                height: 80px;
                font-size: 1.25rem;
            }

            .avatar-placeholder.tiny {
                width: 50px;
                height: 50px;
                font-size: 0.875rem;
            }

            .avatar-placeholder.small {
                width: 70px;
                height: 70px;
                font-size: 1rem;
            }

            .podium-base {
                width: 80px;
            }

            .podium-base.first-place {
                height: 80px;
            }

            .podium-base.second-place {
                height: 65px;
            }

            .podium-base.third-place {
                height: 50px;
            }

            .podium-name {
                font-size: 1rem;
            }

            .podium-score {
                font-size: 0.875rem;
            }

            .champion-crown {
                font-size: 1.5rem;
                top: -12px;
            }
        }
    </style>
</body>
</html> 