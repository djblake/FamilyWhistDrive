<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Tournament Photos | Ruston Family Whist Drive</title>
    <meta name="description" content="Upload tournament-day photos to the gallery.">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="/assets/js/footer-nav.js?v=2" defer></script>
    <script src="/assets/js/media.js?v=1" defer></script>
    <style>
        .upload-wrap { padding: var(--spacing-3xl) 0; }
        .upload-card {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            border: 1px solid rgba(15, 23, 42, 0.10);
            box-shadow: var(--shadow-card);
        }
        .upload-title { font-size: 1.6rem; margin-bottom: 0.25rem; color: var(--text-primary-dark); font-weight: 950; }
        .upload-sub { color: var(--text-secondary-dark); margin-bottom: var(--spacing-lg); }
        .row { display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        @media (max-width: 720px) { .row-2 { grid-template-columns: 1fr; } }
        label { font-weight: 800; color: var(--text-primary-dark); font-size: 0.9rem; }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 0.75rem 0.9rem;
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.18);
            font-size: 0.95rem;
        }
        input[readonly] { background: rgba(15, 23, 42, 0.04); }
        input[type="file"] { width: 100%; }
        .btn-row { display:flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 0.5rem; align-items: center; }
        .small { font-size: 0.85rem; color: var(--text-secondary-dark); }
        .log {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: rgba(15, 23, 42, 0.04);
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-radius: 12px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.85rem;
            color: var(--text-primary-dark);
            max-height: 260px;
            overflow: auto;
            white-space: pre-wrap;
        }
        .pill {
            display:inline-flex;
            align-items:center;
            gap: 0.4rem;
            padding: 0.2rem 0.65rem;
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            background: rgba(15, 23, 42, 0.04);
            font-weight: 800;
            font-size: 0.8rem;
        }
        .pill.ok { border-color: rgba(34, 197, 94, 0.25); background: rgba(34, 197, 94, 0.08); }
        .pill.bad { border-color: rgba(239, 68, 68, 0.25); background: rgba(239, 68, 68, 0.08); }
        .hint-links { display:flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 0.25rem; }
        .hint-links a { font-weight: 800; }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="card-suits"><span class="heart">♥</span> <span class="club">♣</span> <span class="diamond">♦</span> <span class="spade">♠</span></div>
                    <h1 class="site-title">Ruston Family Whist Drive</h1>
                    <p class="site-subtitle">Upload • Tournament Photos</p>
                </div>
                <nav class="main-nav">
                    <a href="../" class="nav-link">Home</a>
                    <a href="../tournaments/" class="nav-link">Tournaments</a>
                    <a href="../players/" class="nav-link">Players</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main-content">
        <section class="upload-wrap">
            <div class="container">
                <div class="upload-card">
                    <div class="upload-title">Upload tournament photos</div>
                    <div class="upload-sub">Add your tournament-day photos to the gallery. We’ll group them under your name.</div>

                    <div class="row">
                        <label for="family-password">Family password</label>
                        <input id="family-password" type="password" placeholder="Family password" autocomplete="current-password">
                        <div class="btn-row">
                            <button class="btn btn-primary" id="btn-unlock" type="button">Unlock uploads</button>
                            <button class="btn btn-secondary" id="btn-lock" type="button" style="display:none;">Lock</button>
                        </div>
                        <div class="small">This creates a short-lived login cookie (no password is stored).</div>
                        <div id="auth-status"></div>
                    </div>

                    <div class="row-2" style="margin-top: 1rem;">
                        <div class="row">
                            <label for="year">Tournament year</label>
                            <input id="year" type="text" placeholder="2025">
                            <div class="hint-links">
                                <a id="back-to-tournament" href="../tournaments/" style="display:none;">← Back to tournament</a>
                                <a id="view-gallery" href="../tournaments/" style="display:none;">View gallery →</a>
                            </div>
                        </div>
                        <div class="row">
                            <label for="uploader-name">Your name</label>
                            <input id="uploader-name" type="text" placeholder="Sarah">
                            <div class="small">This will be shown as the uploader group title.</div>
                        </div>
                    </div>

                    <div class="row" style="margin-top: 0.75rem;">
                        <label for="photo-files">Photos</label>
                        <input id="photo-files" type="file" multiple accept=".jpg,.jpeg,.png,.webp,image/*">
                    </div>

                    <div class="btn-row">
                        <button class="btn btn-primary" id="btn-upload" type="button">Upload photos</button>
                        <button class="btn btn-secondary" id="btn-clear" type="button">Clear</button>
                    </div>

                    <div class="log" id="log" aria-live="polite"></div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div data-footer-nav></div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Ruston Family Whist Drive.</p>
            </div>
        </div>
    </footer>

    <script>
        const UPLOADER_NAME_KEY = 'whist_uploader_name';
        const elPw = document.getElementById('family-password');
        const elAuthStatus = document.getElementById('auth-status');
        const elBtnUnlock = document.getElementById('btn-unlock');
        const elBtnLock = document.getElementById('btn-lock');
        const elYear = document.getElementById('year');
        const elUploaderName = document.getElementById('uploader-name');
        const elFiles = document.getElementById('photo-files');
        const elLog = document.getElementById('log');
        const elBack = document.getElementById('back-to-tournament');
        const elViewGallery = document.getElementById('view-gallery');

        function log(line) {
            const now = new Date().toISOString().slice(11, 19);
            elLog.textContent = `${elLog.textContent}${elLog.textContent ? '\\n' : ''}[${now}] ${line}`;
            elLog.scrollTop = elLog.scrollHeight;
        }

        function setAuthStatus({ ok, message }) {
            if (!elAuthStatus) return;
            if (ok) {
                elAuthStatus.innerHTML = `<span class="pill ok">Unlocked</span>`;
            } else {
                const msg = message ? ` ${String(message).replaceAll('<', '&lt;').replaceAll('>', '&gt;')}` : '';
                elAuthStatus.innerHTML = `<span class="pill bad">Locked</span>${msg ? `<span class="small">${msg}</span>` : ''}`;
            }
            if (elBtnLock) elBtnLock.style.display = ok ? 'inline-flex' : 'none';
        }

        async function refreshAuthStatus() {
            try {
                const res = await fetch('/api/family/status', { cache: 'no-store' });
                if (res.ok) {
                    setAuthStatus({ ok: true });
                    return true;
                }
            } catch (_) {}
            setAuthStatus({ ok: false });
            return false;
        }

        async function unlockUploads() {
            const password = String(elPw.value || '').trim();
            if (!password) return alert('Please enter the family password.');
            const res = await fetch('/api/family/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            const json = await res.json().catch(() => ({}));
            if (!res.ok) {
                setAuthStatus({ ok: false, message: json?.error || res.status });
                return;
            }
            elPw.value = '';
            await refreshAuthStatus();
        }

        async function lockUploads() {
            await fetch('/api/family/logout', { method: 'POST' }).catch(() => {});
            await refreshAuthStatus();
        }

        function getPrefill() {
            const url = new URL(window.location.href);
            const year = String(url.searchParams.get('year') || '').trim();
            return { year };
        }

        function applyPrefill() {
            const { year } = getPrefill();
            if (year) {
                elYear.value = year;
                elYear.setAttribute('readonly', 'readonly');
                elBack.href = `../tournaments/results.html?year=${encodeURIComponent(year)}`;
                elBack.style.display = 'inline';
                elViewGallery.href = `../tournaments/photos.html?year=${encodeURIComponent(year)}`;
                elViewGallery.style.display = 'inline';
            }
        }

        function makePhotoId() {
            const rand = Math.random().toString(36).slice(2, 10);
            return `${Date.now()}_${rand}`;
        }

        async function decodeImageSource(file) {
            if (window.createImageBitmap) {
                try {
                    return await createImageBitmap(file);
                } catch (_) {
                    // fallback below
                }
            }
            const url = URL.createObjectURL(file);
            try {
                const img = new Image();
                img.decoding = 'async';
                img.loading = 'eager';
                const loaded = await new Promise((resolve, reject) => {
                    img.onload = () => resolve(img);
                    img.onerror = () => reject(new Error('Unable to decode image'));
                    img.src = url;
                });
                return loaded;
            } finally {
                URL.revokeObjectURL(url);
            }
        }

        async function renderJpegBlob(source, outW, outH, quality = 0.82) {
            const canvas = document.createElement('canvas');
            canvas.width = outW;
            canvas.height = outH;
            const ctx = canvas.getContext('2d', { alpha: false });
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, outW, outH);
            ctx.drawImage(source, 0, 0, outW, outH);
            return await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', quality));
        }

        async function makeThumbFile(file, maxDim = 720) {
            const source = await decodeImageSource(file);
            const w = source.width || source.naturalWidth || 0;
            const h = source.height || source.naturalHeight || 0;
            if (!w || !h) throw new Error('Unable to read image dimensions');

            const scale = Math.min(1, maxDim / Math.max(w, h));
            const outW = Math.max(1, Math.round(w * scale));
            const outH = Math.max(1, Math.round(h * scale));
            const blob = await renderJpegBlob(source, outW, outH, 0.82);
            if (source && typeof source.close === 'function') {
                try { source.close(); } catch (_) {}
            }
            if (!(blob instanceof Blob)) throw new Error('Unable to create thumbnail');

            const base = String(file.name || 'photo').replace(/\.[^.]+$/, '');
            return new File([blob], `${base}_thumb.jpg`, { type: 'image/jpeg' });
        }

        async function uploadOnePhoto({ year, uploaderName, file, variant = '', photoId = '' }) {
            const fd = new FormData();
            fd.set('kind', 'tournament-photo');
            fd.set('year', year);
            fd.set('uploaderName', uploaderName);
            if (variant) fd.set('variant', variant);
            if (photoId) fd.set('photoId', photoId);
            fd.set('file', file, file.name);
            const res = await fetch('/api/media/upload', { method: 'POST', body: fd });
            const json = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(json?.error || `Upload failed (${res.status})`);
            return json;
        }

        async function autoPickCovers({ year }) {
            if (!(window.WhistMedia && typeof window.WhistMedia.getTournamentMeta === 'function')) return;
            const meta = await window.WhistMedia.getTournamentMeta(year);
            const photos = Array.isArray(meta?.photos) ? meta.photos.slice() : [];
            photos.sort((a, b) => String(b?.uploadedAt || '').localeCompare(String(a?.uploadedAt || '')));
            const picks = photos.map(p => String(p?.key || '')).filter(Boolean).slice(0, 3);
            if (picks.length === 0) return;
            const res = await fetch('/api/media/tournament-meta', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ year, coverPicks: picks })
            });
            const json = await res.json().catch(() => ({}));
            if (!res.ok) {
                log(`Cover picks not updated: ${json?.error || res.status}`);
                return;
            }
            log(`Cover photos updated (${(json.coverPicks || []).length}).`);
        }

        async function uploadAll() {
            const authed = await refreshAuthStatus();
            if (!authed) return alert('Please unlock uploads with the family password first.');
            const year = String(elYear.value || '').trim();
            const uploaderName = String(elUploaderName.value || '').trim();
            const files = Array.from(elFiles.files || []);
            if (!/^\d{4}$/.test(year)) return alert('Enter a valid year (YYYY).');
            if (!uploaderName) return alert('Please enter your name.');
            if (files.length === 0) return alert('Please choose at least one photo.');

            try { localStorage.setItem(UPLOADER_NAME_KEY, uploaderName); } catch (_) {}

            log(`Uploading ${files.length} photo(s) for ${year} as "${uploaderName}"...`);
            let ok = 0;
            let fail = 0;
            for (let i = 0; i < files.length; i++) {
                const f = files[i];
                try {
                    const photoId = makePhotoId();
                    const out = await uploadOnePhoto({ year, uploaderName, file: f, variant: 'full', photoId });
                    let thumbOut = null;
                    try {
                        const thumbFile = await makeThumbFile(f, 720);
                        thumbOut = await uploadOnePhoto({ year, uploaderName, file: thumbFile, variant: 'thumb', photoId });
                    } catch (thumbErr) {
                        log(`WARN ${i + 1}/${files.length}: thumbnail not created/uploaded (${thumbErr?.message || thumbErr})`);
                    }
                    ok++;
                    log(`OK ${i + 1}/${files.length}: ${f.name} → ${out.key}${thumbOut?.key ? ` (thumb: ${thumbOut.key})` : ''}`);
                } catch (e) {
                    fail++;
                    log(`FAIL ${i + 1}/${files.length}: ${f.name} → ${e.message || e}`);
                }
            }
            log(`Done. Success: ${ok}. Failed: ${fail}.`);
            await autoPickCovers({ year }).catch(() => {});
        }

        document.getElementById('btn-upload').addEventListener('click', () => uploadAll().catch(e => log(`FAIL: ${e.message || e}`)));
        document.getElementById('btn-clear').addEventListener('click', () => {
            elFiles.value = '';
            elLog.textContent = '';
        });
        elBtnUnlock.addEventListener('click', () => unlockUploads().catch(e => alert(e?.message || e)));
        elBtnLock.addEventListener('click', () => lockUploads().catch(() => {}));

        applyPrefill();
        try {
            const n = localStorage.getItem(UPLOADER_NAME_KEY) || '';
            if (n) elUploaderName.value = n;
        } catch (_) {}
        refreshAuthStatus().catch(() => {});
    </script>
</body>
</html>


