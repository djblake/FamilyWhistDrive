<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partnership Games | Ruston Family Whist Drive</title>
    <meta name="description" content="All games played with a specific partner.">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="/assets/js/footer-nav.js?v=2" defer></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="card-suits"><span class="heart">‚ô•</span> <span class="club">‚ô£</span> <span class="diamond">‚ô¶</span> <span class="spade">‚ô†</span></div>
                    <h1 class="site-title">Ruston Family Whist Drive</h1>
                    <p class="site-subtitle">Est. 1984 ‚Ä¢ The World's Most Elite Family Tournament</p>
                </div>
                <nav class="main-nav">
                    <a href="../" class="nav-link">Home</a>
                    <a href="../tournaments/" class="nav-link">Tournaments</a>
                    <a href="../tables/" class="nav-link">Tables</a>
                    <a href="./" class="nav-link active">Players</a>
                    <a href="../leaderboard/" class="nav-link">Hall of Fame</a>
                    <a href="../stats/" class="nav-link">Statistics</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main-content">
        <section class="players-table-section">
            <div class="container">
                <div class="page-nav">
                    <a class="back-link" id="back-to-partnerships" href="./">‚Üê Back to partnerships</a>
                </div>

                <div class="page-head">
                    <h2 class="section-title light">
                        <span class="title-icon">üóÇÔ∏è</span>
                        All games together
                    </h2>

                    <div class="page-head-row">
                        <div class="player-title-big" id="pair-title-big">Loading‚Ä¶</div>
                    </div>

                    <div class="page-subtitle-row">
                        <p class="page-subtitle" id="page-subtitle">Loading‚Ä¶</p>
                        <div class="page-tools">
                            <label class="sample-filter-toggle sample-filter-toggle--dark" for="filter-shared">
                                <input type="checkbox" id="filter-shared">
                                <span class="sample-filter-toggle__text">Exclude shared-hand games</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="players-table">
                        <colgroup>
                            <col style="width: 8%">
                            <col style="width: 8%">
                            <col style="width: 14%">
                            <col style="width: 20%">
                            <col style="width: 20%">
                            <col style="width: 8%">
                            <col style="width: 8%">
                            <col style="width: 8%">
                            <col style="width: 14%">
                        </colgroup>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Round</th>
                                <th>Trump</th>
                                <th>Your side</th>
                                <th>Opponents</th>
                                <th class="num">Tricks</th>
                                <th class="num">Shared</th>
                                <th class="num">Win</th>
                                <th class="cta"></th>
                            </tr>
                        </thead>
                        <tbody id="games-tbody">
                            <tr>
                                <td colspan="9" style="text-align:center; padding: 2rem; color: #666;">
                                    Loading games‚Ä¶
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div data-footer-nav></div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Ruston Family Whist Drive.</p>
            </div>
        </div>
    </footer>

    <script src="../assets/js/tournament-engine.js?v=cache3"></script>
    <script>
        function getParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function escapeHtml(str) {
            return String(str ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function suitIcon(suit) {
            const map = { Hearts: '‚ô•', Diamonds: '‚ô¶', Clubs: '‚ô£', Spades: '‚ô†' };
            return map[suit] || '‚Äî';
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const playerId = getParam('player');
            const partnerId = getParam('partner');
            if (!playerId || !partnerId) {
                // Don't redirect (family site; keep URL intact). Show a helpful message instead.
                document.title = 'All games together ‚Äî Missing player/partner';
                const subtitle = document.getElementById('page-subtitle');
                if (subtitle) subtitle.textContent = 'Missing required URL parameters: player and partner.';
                const big = document.getElementById('pair-title-big');
                if (big) big.textContent = 'Missing player/partner';
                const body = document.getElementById('games-tbody');
                if (body) {
                    body.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align:center; padding: 2rem; color: #444;">
                                <div style="font-weight: 900; margin-bottom: 0.35rem;">This page needs URL parameters</div>
                                <div style="color:#666; margin-bottom: 0.75rem;">Use the ‚ÄúSee all games‚Äù buttons (or add <code>?player=Name&partner=Name</code> to the URL).</div>
                                <div style="display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap;">
                                    <a class="btn btn-secondary" href="./">Back to Players</a>
                                    <a class="btn btn-primary" href="../stats/">Go to Statistics</a>
                                </div>
                            </td>
                        </tr>
                    `;
                }
                return;
            }

            const engine = new TournamentEngine();
            window.tournamentEngine = engine;
            const sheetId = '1HGfdlDOfGHOL6Q4MP_TnF8UNE6YihBW-5gQs6Ykl78k';

            try {
                await engine.loadFromGoogleSheets(sheetId);

                const pName = (engine && typeof engine.getPlayerFullName === 'function') ? engine.getPlayerFullName(playerId) : playerId;
                const partnerName = (engine && typeof engine.getDisplayName === 'function') ? engine.getDisplayName(partnerId) : partnerId;

                document.title = `${pName} √ó ${partnerName} ‚Äì Games | Ruston Family Whist Drive`;
                const subtitle = document.getElementById('page-subtitle');
                if (subtitle) subtitle.textContent = `${pName} with ${partnerName} ‚Ä¢ chronological`;
                const big = document.getElementById('pair-title-big');
                if (big) big.textContent = `${pName} √ó ${partnerName}`;

                const back = document.getElementById('back-to-partnerships');
                if (back) back.href = `partnerships.html?player=${encodeURIComponent(playerId)}`;

                const games = [];
                const display = (id) => (engine && typeof engine.getDisplayName === 'function') ? engine.getDisplayName(id) : id;

                for (const t of engine.tournaments.values()) {
                    if (!t || !Array.isArray(t.rounds)) continue;
                    const year = Number.isFinite(t.year) ? t.year : (Number.isFinite(t.Year) ? t.Year : null);
                    for (const r of t.rounds) {
                        if (!r || !Array.isArray(r.tables)) continue;
                        const roundNum = Number.isFinite(r.round) ? r.round : (Number.isFinite(r.Round) ? r.Round : parseInt(r.round || r.Round || '0'));
                        for (const table of r.tables) {
                            const tableNum = Number.isFinite(table.table) ? table.table : parseInt(table.table || '0');
                            const partnerships = table && Array.isArray(table.partnerships) ? table.partnerships : [];
                            for (const p of partnerships) {
                                if (!p || !Array.isArray(p.position1) || !Array.isArray(p.position2)) continue;
                                const sidePlayers = Array.from(new Set([...(p.position1 || []), ...(p.position2 || [])])).filter(Boolean);
                                if (!sidePlayers.includes(playerId)) continue;
                                if (!sidePlayers.includes(partnerId)) continue;

                                const opp = partnerships.find(x => x !== p) || null;
                                const oppPos1 = opp && Array.isArray(opp.position1) ? opp.position1.filter(Boolean) : [];
                                const oppPos2 = opp && Array.isArray(opp.position2) ? opp.position2.filter(Boolean) : [];

                                const tricks = Number.isFinite(p.tricks) ? p.tricks : parseFloat(p.tricks);
                                if (!Number.isFinite(tricks)) continue;

                                const suit = p.trump_suit || r.trump_suit || 'Unknown';
                                const isWin = tricks >= 7;
                                const isSharedHand = !(p.position1.length === 1 && p.position2.length === 1 && sidePlayers.length === 2);

                                const pos1 = (p.position1 || []).filter(Boolean);
                                const pos2 = (p.position2 || []).filter(Boolean);
                                const playerInPos1 = pos1.includes(playerId);
                                const playerSeat = playerInPos1 ? pos1 : pos2;
                                const otherSeat = playerInPos1 ? pos2 : pos1;

                                // Show the full partnership seats clearly:
                                // - Within a shared hand: "David/Jennifer"
                                // - Between seats: "David/Jennifer & Jon"
                                const orderedSeat = (seat, primaryId) => {
                                    const ids = Array.isArray(seat) ? seat.filter(Boolean) : [];
                                    if (primaryId && ids.includes(primaryId)) {
                                        return [primaryId, ...ids.filter(x => x !== primaryId)];
                                    }
                                    return ids;
                                };
                                const yourPlayerSeatIds = orderedSeat(playerSeat, playerId);
                                const yourOtherSeatIds = orderedSeat(otherSeat, partnerId);

                                const opponentsSeat1Ids = oppPos1.slice();
                                const opponentsSeat2Ids = oppPos2.slice();

                                games.push({
                                    year: Number.isFinite(year) ? year : 0,
                                    round: Number.isFinite(roundNum) ? roundNum : 0,
                                    table: Number.isFinite(tableNum) ? tableNum : 0,
                                    suit,
                                    yourPlayerSeatIds,
                                    yourOtherSeatIds,
                                    opponentsSeat1Ids,
                                    opponentsSeat2Ids,
                                    tricks,
                                    isSharedHand,
                                    isWin
                                });
                            }
                        }
                    }
                }

                games.sort((a, b) => (a.year - b.year) || (a.round - b.round) || (a.table - b.table));

                const tbody = document.getElementById('games-tbody');
                if (!tbody) return;

                const filterEl = document.getElementById('filter-shared');
                const getView = () => {
                    const excludeShared = !!(filterEl && filterEl.checked);
                    return excludeShared ? games.filter(g => !g.isSharedHand) : games.slice();
                };

                const render = () => {
                    const view = getView();
                    if (!view.length) {
                        tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 2rem; color:#666;">No games found for this partnership.</td></tr>`;
                        return;
                    }

                    tbody.innerHTML = view.map(g => {
                        const isRed = g.suit === 'Hearts' || g.suit === 'Diamonds';
                        const trump = g.suit ? `<span class="suit ${isRed ? 'suit--red' : 'suit--dark'}">${escapeHtml(suitIcon(g.suit))} ${escapeHtml(g.suit)}</span>` : '‚Äî';
                        const renderHands = (handAIds, handBIds) => {
                            const a = Array.isArray(handAIds) ? handAIds.filter(Boolean) : [];
                            const b = Array.isArray(handBIds) ? handBIds.filter(Boolean) : [];
                            const parts = [];

                            const nameLink = (id) => {
                                const href = `profile.html?player=${encodeURIComponent(id)}`;
                                return `<a class="name-link" href="${href}">${escapeHtml(display(id))}</a>`;
                            };

                            const seatHtml = (ids) => ids.map(nameLink).join('<span class="seat-sep">/</span>');
                            if (a.length) parts.push(seatHtml(a));
                            if (b.length) parts.push(seatHtml(b));

                            return parts.length ? parts.join('<span class="hand-sep"> & </span>') : '‚Äî';
                        };
                        const yourSide = renderHands(g.yourPlayerSeatIds, g.yourOtherSeatIds);
                        const opp = renderHands(g.opponentsSeat1Ids, g.opponentsSeat2Ids);
                        const scorecardHref = `../tournaments/scorecard.html?year=${encodeURIComponent(g.year)}&player=${encodeURIComponent(playerId)}`;
                        return `
                            <tr>
                                <td>${g.year || '‚Äî'}</td>
                                <td>${g.round || '‚Äî'}</td>
                                <td>${trump}</td>
                                <td>${yourSide}</td>
                                <td>${opp}</td>
                                <td class="num">${g.tricks}</td>
                                <td class="num" style="color:${g.isSharedHand ? '#0ea5e9' : 'rgba(15,23,42,0.35)'};">${g.isSharedHand ? 'ü§ù' : '‚Äî'}</td>
                                <td class="num" style="color:${g.isWin ? '#16a34a' : '#b91c1c'};">${g.isWin ? 'Win' : 'Loss'}</td>
                                <td class="cta">
                                    <a class="profile-link" href="${scorecardHref}">See scorecard</a>
                                </td>
                            </tr>
                        `;
                    }).join('');
                };

                render();
                if (filterEl) filterEl.addEventListener('change', render);
            } catch (e) {
                console.error(e);
                const tbody = document.getElementById('games-tbody');
                if (tbody) tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 2rem; color:#666;">Error loading games.</td></tr>`;
            }
        });
    </script>

    <style>
        .players-table-section {
            padding: var(--spacing-3xl) 0;
            background: var(--bg-secondary);
        }

        .section-title.light {
            color: var(--text-primary);
        }

        .page-nav {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 0.85rem;
        }

        .page-head {
            margin-bottom: var(--spacing-md);
        }

        .page-head-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 0.45rem;
            margin-bottom: 0.35rem;
        }

        .page-subtitle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 0.65rem;
        }

        .page-tools {
            display: flex;
            justify-content: flex-end;
            flex: 0 0 auto;
        }

        .player-title-big {
            font-family: var(--font-primary);
            font-weight: 900;
            font-size: 2.2rem;
            line-height: 1.05;
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 0;
        }

        .page-subtitle {
            margin: 0;
            color: var(--text-secondary);
            font-weight: 700;
            max-width: 60rem;
            flex: 1 1 auto;
        }

        /* Hall-of-fame style toggle */
        .sample-filter-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary-dark);
            user-select: none;
        }

        .sample-filter-toggle input {
            accent-color: var(--primary);
        }

        .sample-filter-toggle__text {
            font-weight: 600;
            color: var(--text-primary-dark);
        }

        .sample-filter-toggle__hint {
            color: var(--text-secondary-dark);
            opacity: 0.85;
            font-weight: 500;
        }

        .sample-filter-toggle--dark {
            color: var(--text-secondary);
        }

        .sample-filter-toggle--dark .sample-filter-toggle__text {
            color: var(--text-primary);
        }

        .sample-filter-toggle--dark .sample-filter-toggle__hint {
            color: var(--text-secondary);
            opacity: 0.9;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            text-decoration: none;
            font-weight: 800;
            padding: 0.75rem 1.1rem;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.22);
            background: rgba(255, 255, 255, 0.10);
            color: var(--text-primary);
        }

        .back-link:hover {
            text-decoration: underline;
        }

        /* Table readability */
        .table-container {
            background: white;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        .players-table {
            font-size: 0.95rem;
            background: white;
            width: 100%;
            table-layout: fixed;
        }

        .players-table th,
        .players-table td {
            padding: 1rem 1.05rem;
        }

        .players-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #eef2f7 100%);
            color: var(--text-primary-dark);
            border-bottom: 1px solid rgba(15, 23, 42, 0.10);
        }

        .players-table td {
            color: var(--text-primary-dark);
            border-bottom: 1px solid rgba(15, 23, 42, 0.06);
        }

        .players-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .players-table tbody tr:hover {
            background: rgba(34, 197, 94, 0.08);
        }

        .suit {
            font-weight: 900;
        }

        .suit--red {
            color: #dc2626;
        }

        .suit--dark {
            color: var(--text-primary-dark);
        }

        /* Keep trump text/icons on one line (e.g., "‚ô¶ Diamonds") */
        .players-table th:nth-child(3),
        .players-table td:nth-child(3) {
            white-space: nowrap;
        }

        .profile-link {
            color: var(--primary-dark);
            font-weight: 900;
            white-space: nowrap;
        }

        .name-link {
            color: var(--primary-dark);
            font-weight: 800;
            text-decoration: none;
        }

        .name-link:hover {
            text-decoration: underline;
        }

        .seat-sep {
            color: var(--text-secondary-dark);
            font-weight: 800;
            padding: 0 0.1rem;
        }

        .hand-sep {
            color: var(--text-secondary-dark);
            font-weight: 700;
            padding: 0 0.35rem;
        }

        .num {
            text-align: center;
            font-weight: 800;
        }

        .cta {
            text-align: right;
        }

        .players-table td.cta,
        .players-table th.cta {
            min-width: 160px;
        }
    </style>
</body>
</html>
