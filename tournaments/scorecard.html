<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Player Scorecard - Ruston Family Whist Drive</title>
    <meta name="description" content="Detailed scorecard and tournament performance analysis">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="card-suits"><span class="heart">‚ô•</span> <span class="club">‚ô£</span> <span class="diamond">‚ô¶</span> <span class="spade">‚ô†</span></div>
                    <h1 class="site-title">Ruston Family Whist Drive</h1>
                    <p class="site-subtitle">Est. 1984 ‚Ä¢ The World's Most Elite Family Tournament</p>
                </div>
                <nav class="main-nav">
                    <a href="../" class="nav-link">Home</a>
                    <a href="../tournaments/" class="nav-link">Tournaments</a>
                    <a href="../players/" class="nav-link">Players</a>
                    <a href="../leaderboard/" class="nav-link">Hall of Fame</a>
                    <a href="../stats/" class="nav-link">Statistics</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- Loading State -->
        <section class="loading-section" id="loading-section">
            <div class="container">
                <div class="loading-content">
                    <div class="loading-spinner">üé¥</div>
                    <h2>Loading Player Scorecard...</h2>
                    <p>Retrieving tournament data from archives...</p>
                </div>
            </div>
        </section>

        <!-- Error State -->
        <section class="error-section" id="error-section" style="display: none;">
            <div class="container">
                <div class="error-content">
                    <div class="error-icon">‚ùå</div>
                    <h2>Scorecard Not Found</h2>
                    <p id="error-message">Unable to load player scorecard data.</p>
                    <a href="../tournaments/" class="btn btn-primary">‚Üê Back to Tournaments</a>
                </div>
            </div>
        </section>

        <!-- Player Scorecard Content -->
        <section class="player-scorecard" id="scorecard-content" style="display: none;">
            <div class="container">
                <!-- Player Header -->
                <div class="player-header">
                    <div class="player-info">
                        <div class="back-link">
                            <a href="#" id="back-to-tournament">‚Üê Back to Tournament</a>
                        </div>
                        <h1 class="player-name" id="player-name">Loading...</h1>
                        <p class="tournament-context" id="tournament-context">Tournament Context</p>
                        <div class="player-rank">
                            <span class="rank-badge" id="player-rank">Loading...</span>
                            <span class="performance-summary" id="performance-summary">Performance Summary</span>
                        </div>
                    </div>
                    <div class="tournament-summary">
                        <div class="summary-stats">
                            <div class="stat">
                                <span class="stat-value" id="total-tricks">--</span>
                                <span class="stat-label">Total Tricks</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" id="average-tricks">--</span>
                                <span class="stat-label">Average</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" id="rounds-played">--</span>
                                <span class="stat-label">Rounds</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" id="best-round">--</span>
                                <span class="stat-label">Most Tricks</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Complete Round-by-Round Scorecard -->
                <div class="scorecard-section">
                    <h2 class="section-title">
                        <span class="title-icon">üìã</span>
                        Complete Tournament Scorecard
                    </h2>
                    <div class="scorecard-table-container">
                        <table class="scorecard-table" id="scorecard-table">
                            <thead>
                                <tr>
                                    <th>Round</th>
                                    <th>Trump</th>
                                    <th>Table</th>
                                    <th>Partner</th>
                                    <th>Our Tricks</th>
                                    <th>Their Tricks</th>
                                    <th>Opponents</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody id="scorecard-body">
                                <!-- Will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Photo Upload Section -->
                <div class="photo-section">
                    <h3>Scorecard Verification</h3>
                    <div class="photo-upload-info">
                        <p>üì∏ Original scorecard photos can be uploaded to:</p>
                        <code id="photo-path">tournaments/YEAR/PLAYER/</code>
                        <p>Photos will automatically appear here for verification against the digital scorecard above.</p>
                    </div>
                    <div id="scorecard-photos">
                        <!-- Photos will be loaded here if available -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="../assets/js/tournament-engine.js"></script>
    <script src="../assets/js/photo-gallery.js"></script>
</body>
</html>
    <script>
        // Parse URL parameters
        function parseURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                year: urlParams.get('year'),
                player: urlParams.get('player')
            };
        }

        // Initialize scorecard page
        document.addEventListener('DOMContentLoaded', function() {
            initializeScorecardPage();
        });

        async function initializeScorecardPage() {
            try {
                const params = parseURLParameters();
                
                if (!params.year || !params.player) {
                    throw new Error('Missing year or player parameter in URL');
                }

                console.log(`üé¥ Loading scorecard for ${params.player} in ${params.year}`);

                // Update page elements
                document.getElementById('page-title').textContent = `${params.player} - ${params.year} Tournament Scorecard`;
                document.getElementById('photo-path').textContent = `tournaments/${params.year}/${params.player.toLowerCase().replace(/\s+/g, '-')}/`;

                // Load tournament data
                const engine = new TournamentEngine();
                const sheetId = '1HGfdlDOfGHOL6Q4MP_TnF8UNE6YihBW-5gQs6Ykl78k';
                
                await engine.loadFromGoogleSheets(sheetId);
                
                // Find tournament and player
                const tournaments = Array.from(engine.tournaments.values());
                const tournament = tournaments.find(t => t.year.toString() === params.year);
                
                if (!tournament) {
                    throw new Error(`Tournament for year ${params.year} not found`);
                }

                // Use the new method to get individual player data (handles partnerships)
                const playerStanding = engine.getIndividualPlayerData(tournament, params.player);

                if (!playerStanding) {
                    throw new Error(`Player ${params.player} not found in ${params.year} tournament`);
                }

                // Generate scorecard
                await generatePlayerScorecard(tournament, playerStanding, params);

                // Try to load photos
                await loadScorecardPhotos(params.year, params.player.toLowerCase().replace(/\s+/g, '-'));

                // Hide loading, show content
                document.getElementById('loading-section').style.display = 'none';
                document.getElementById('scorecard-content').style.display = 'block';

            } catch (error) {
                console.error('Error loading scorecard:', error);
                showError(error.message);
            }
        }

        async function generatePlayerScorecard(tournament, playerStanding, params) {
            const playerName = playerStanding.player;

            // Update player header
            document.getElementById('player-name').textContent = playerName;
            
            // Show partnership information if applicable
            let contextText = `${tournament.name} ‚Ä¢ ${tournament.year}`;
            if (playerStanding.is_partnership_member) {
                contextText += ` ‚Ä¢ Partnership: ${playerStanding.partnership_name}`;
            }
            document.getElementById('tournament-context').textContent = contextText;
            
            // Update back link  
            document.getElementById('back-to-tournament').href = `../tournaments/#${params.year}`;
            
            // Update rank and performance
            const rankText = playerStanding.position === 1 ? 'üèÜ Champion' : 
                           playerStanding.position === 2 ? 'ü•à Runner-up' :
                           playerStanding.position === 3 ? 'ü•â Third Place' :
                           `#${playerStanding.position}`;
            
            document.getElementById('player-rank').textContent = rankText;
            
            // Update performance summary with partnership info
            let performanceText = `${playerStanding.total_tricks} tricks in ${playerStanding.rounds_played} rounds`;
            if (playerStanding.is_partnership_member) {
                performanceText += ` (as partnership)`;
            }
            document.getElementById('performance-summary').textContent = performanceText;

            // Update summary stats
            document.getElementById('total-tricks').textContent = playerStanding.total_tricks;
            document.getElementById('average-tricks').textContent = playerStanding.average_tricks;
            document.getElementById('rounds-played').textContent = playerStanding.rounds_played;

            // Get player's individual rounds
            const playerRounds = getPlayerRounds(tournament, playerName);
            const maxTricks = Math.max(...playerRounds.map(r => r.tricks));
            
            // Count how many times they achieved the maximum
            const maxTricksCount = playerRounds.filter(r => r.tricks === maxTricks).length;
            
            // Display with count if achieved more than once
            let mostTricksText = maxTricks.toString();
            if (maxTricksCount > 1) {
                mostTricksText += ` (x${maxTricksCount})`;
            }
            
            document.getElementById('best-round').textContent = mostTricksText;

            // Generate scorecard table
            generateScorecardTable(playerRounds);
        }

        function getPlayerRounds(tournament, playerName) {
            const playerRounds = [];
            
            console.log(`üîç Looking for rounds for player: "${playerName}"`);

            for (const round of tournament.rounds) {
                let foundInRound = false;
                for (const table of round.tables) {
                    for (const partnership of table.partnerships) {
                        console.log(`  Round ${round.round}, Table ${table.table}: Partnership players:`, partnership.players);
                        
                        let playerMatch = false;
                        let partnerName = null;
                        
                        // Check each player slot in the partnership
                        for (const partnershipPlayer of partnership.players) {
                            // Case 1: Direct exact match
                            if (partnershipPlayer.toLowerCase() === playerName.toLowerCase()) {
                                playerMatch = true;
                                partnerName = partnership.players.find(p => p.toLowerCase() !== playerName.toLowerCase()) || 'Unknown';
                                console.log(`    ‚úì Direct match found! Partner: ${partnerName}`);
                                break;
                            }
                            
                            // Case 2: Player is part of a combined name (e.g., "Paul + Marci")
                            if (partnershipPlayer.includes('+')) {
                                const partnershipMembers = partnershipPlayer.split('+').map(name => name.trim());
                                console.log(`    Checking combined name "${partnershipPlayer}" -> [${partnershipMembers.join(', ')}]`);
                                
                                if (partnershipMembers.some(member => member.toLowerCase() === playerName.toLowerCase())) {
                                    playerMatch = true;
                                    partnerName = partnershipMembers
                                        .filter(member => member.toLowerCase() !== playerName.toLowerCase())
                                        .join(' + ');
                                    console.log(`    ‚úì Found in combined name! Partner: ${partnerName}`);
                                    break;
                                }
                            }
                        }
                        
                        if (playerMatch) {
                            playerRounds.push({
                                round: round.round,
                                trump: partnership.trump_suit || round.trump_suit,
                                table: table.table,
                                partner: partnerName || 'Unknown',
                                opponents: partnership.opponents,
                                tricks: partnership.tricks,
                                opponentTricks: 13 - partnership.tricks,
                                won: partnership.tricks > 6
                            });
                            foundInRound = true;
                            break;
                        }
                    }
                    if (foundInRound) break;
                }
                if (!foundInRound) {
                    console.log(`  ‚ùå Player "${playerName}" not found in round ${round.round}`);
                }
            }
            
            console.log(`üéØ Found ${playerRounds.length} rounds for ${playerName}`);
            return playerRounds.sort((a, b) => a.round - b.round);
        }

        function generateScorecardTable(playerRounds) {
            const tbody = document.getElementById('scorecard-body');
            
            const html = playerRounds.map(round => {
                const resultClass = round.won ? 'result-win' : 'result-loss';
                const resultText = round.won ? 'WIN' : 'LOSS';
                const trumpSymbol = getTrumpSymbol(round.trump);
                
                return `
                    <tr class="round-row ${resultClass}">
                        <td class="round-number">${round.round}</td>
                        <td class="trump-suit">
                            <span class="trump-symbol ${round.trump.toLowerCase()}">${trumpSymbol}</span>
                            ${round.trump}
                        </td>
                        <td class="table-number">${round.table}</td>
                        <td class="partner-name">${round.partner || 'Unknown'}</td>
                        <td class="our-tricks">${round.tricks}</td>
                        <td class="their-tricks">${round.opponentTricks}</td>
                        <td class="opponents-names">${round.opponents.join(' & ')}</td>
                        <td class="result ${resultClass}">${resultText}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html;
        }

        function getTrumpSymbol(suit) {
            const symbols = {
                'Hearts': '‚ô•',
                'Diamonds': '‚ô¶',
                'Spades': '‚ô†',
                'Clubs': '‚ô£'
            };
            return symbols[suit] || 'üé¥';
        }

        async function loadScorecardPhotos(year, playerSlug) {
            try {
                const gallery = new PhotoGallery();
                const photosPath = `tournaments/${year}/${playerSlug}`;
                
                // Try to load photos from the player's folder
                await gallery.loadPlayerScorecardPhotos(year, playerSlug);
                gallery.createScorecardPhotosHTML(photosPath, '#scorecard-photos');
            } catch (error) {
                console.log('No scorecard photos found for this player');
                document.getElementById('scorecard-photos').innerHTML = 
                    '<p style="color: #666; font-style: italic;">No scorecard photos uploaded yet.</p>';
            }
        }

        function showError(message) {
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('error-section').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }
    </script>

    <style>
        /* Loading and Error States */
        .loading-section, .error-section {
            padding: var(--spacing-3xl) 0;
            text-align: center;
        }

        .loading-spinner {
            font-size: 4rem;
            animation: spin 2s linear infinite;
            margin-bottom: var(--spacing-lg);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-lg);
        }

        /* Player Header */
        .player-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: var(--spacing-2xl) 0;
            margin-bottom: var(--spacing-2xl);
        }

        .player-info {
            text-align: center;
        }

        .back-link {
            margin-bottom: var(--spacing-md);
        }

        .back-link a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .back-link a:hover {
            color: white;
        }

        .player-name {
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: var(--spacing-sm);
        }

        .tournament-context {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: var(--spacing-lg);
        }

        .player-rank {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .rank-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius-xl);
            font-size: 1.25rem;
            font-weight: 700;
        }

        .tournament-summary {
            margin-top: var(--spacing-xl);
        }

        .summary-stats {
            display: flex;
            justify-content: center;
            gap: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .summary-stats .stat {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            min-width: 100px;
        }

        .summary-stats .stat-value {
            display: block;
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: var(--spacing-xs);
        }

        .summary-stats .stat-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        /* Scorecard Table */
        .scorecard-section {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-2xl);
            box-shadow: var(--shadow-lg);
            margin-bottom: var(--spacing-2xl);
            color: #1f2937; /* Ensure dark text on white background */
        }

        .scorecard-section .section-title {
            color: #1f2937; /* Dark color for section title */
        }

        .scorecard-table-container {
            overflow-x: auto;
        }

        .scorecard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--spacing-lg);
        }

        .scorecard-table th {
            background: var(--primary);
            color: white;
            padding: var(--spacing-md);
            text-align: left;
            font-weight: 600;
        }

        .scorecard-table td {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
            color: #1f2937; /* Ensure dark text in table body */
        }

        .round-row:hover {
            background: rgba(var(--primary-rgb), 0.05);
        }

        .result-win {
            background: rgba(34, 197, 94, 0.1);
        }

        .result-loss {
            background: rgba(239, 68, 68, 0.1);
        }

        .result.result-win {
            color: #059669;
            font-weight: 600;
        }

        .result.result-loss {
            color: #dc2626;
            font-weight: 600;
        }

        .trump-symbol {
            margin-right: var(--spacing-xs);
        }

        .trump-symbol.hearts { color: #dc2626; }
        .trump-symbol.diamonds { color: #dc2626; }
        .trump-symbol.spades { color: #000; }
        .trump-symbol.clubs { color: #000; }

        /* Photo Section */
        .photo-section {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-2xl);
            box-shadow: var(--shadow-lg);
            color: #1f2937; /* Ensure dark text on white background */
        }

        .photo-section h3 {
            color: #1f2937; /* Dark color for "Scorecard Verification" heading */
            margin-bottom: var(--spacing-lg);
        }

        /* Global section title styling for readability */
        .section-title {
            color: #1f2937 !important; /* Ensure all section titles are dark */
        }

        .photo-upload-info {
            background: #f8f9fa; /* Light gray background */
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-xl);
            color: #1f2937; /* Dark text for readability */
        }

        .photo-upload-info p {
            color: #1f2937; /* Ensure paragraph text is dark */
            margin-bottom: var(--spacing-sm);
        }

        .photo-upload-info code {
            background: #2d3748; /* Dark background */
            color: #fbbf24; /* Gold/yellow text for good contrast */
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            font-family: monospace;
            font-weight: 600;
        }

        /* Scorecard Photo Gallery Styles */
        .scorecard-photo-gallery {
            margin-top: var(--spacing-lg);
        }

        .scorecard-photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }

        .scorecard-photo-card {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .scorecard-photo-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .scorecard-placeholder {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed #dee2e6;
            position: relative;
        }

        .verification-badge {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            background: var(--accent);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .scorecard-photo-card .photo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .scorecard-photo-card:hover .photo-overlay {
            opacity: 1;
        }

        .scorecard-photo-card .photo-view-btn {
            background: white;
            border: none;
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .scorecard-photo-card .photo-view-btn:hover {
            background: var(--accent);
            color: white;
            transform: scale(1.05);
        }

        /* Lightbox enhancement for scorecard mode */
        .lightbox-overlay.scorecard-mode .lightbox-container {
            max-width: 90vw;
            max-height: 90vh;
        }

        .lightbox-overlay.scorecard-mode .lightbox-info {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: var(--spacing-lg);
        }

        .lightbox-overlay.scorecard-mode .lightbox-title {
            color: var(--accent);
            font-size: 1.5rem;
            margin-bottom: var(--spacing-sm);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .player-name {
                font-size: 2rem;
            }

            .summary-stats {
                gap: var(--spacing-md);
            }

            .summary-stats .stat {
                min-width: 80px;
                padding: var(--spacing-sm);
            }

            .scorecard-table {
                font-size: 0.875rem;
            }

            .scorecard-table th,
            .scorecard-table td {
                padding: var(--spacing-sm);
            }

            .scorecard-photo-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }

            .scorecard-placeholder {
                height: 150px;
            }
        }
    </style>
