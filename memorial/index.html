<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memorial | Ruston Family Whist Drive</title>
    <meta name="description" content="In memoriam. A memorial of deceased players and their whist careers.">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="/assets/js/footer-nav.js?v=4" defer></script>
</head>
<body>
        <header class="header">
        <div class="container">
            <div data-header-nav></div>
        </div>
    </header>

    <main class="main-content">
        <section class="memorial-hero">
            <div class="container">
                <div class="hero-content">
                    <div class="analytics-badge">üïäÔ∏è IN MEMORIAM</div>
                    <h1 class="hero-title">Memorial</h1>
                    <p class="hero-subtitle">Remembering our players ‚Äî and celebrating their whist careers.</p>
                </div>
            </div>
        </section>

        <section class="memorial-section">
            <div class="container">
                <div class="memorial-list" id="memorial-list">
                    <div class="loading-message">Loading memorial‚Ä¶</div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div data-footer-nav></div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Ruston Family Whist Drive.</p>
            </div>
        </div>
    </footer>

    <script src="../assets/js/tournament-engine.js"></script>
    <script>
        function getParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function escapeHtml(str) {
            return String(str ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function initialsFromName(fullName) {
            const parts = String(fullName || '').trim().split(/\s+/).filter(Boolean);
            if (!parts.length) return '‚Äî';
            return parts.slice(0, 2).map(p => p[0]).join('').toUpperCase();
        }

        function renderTrophyCabinetHtml(playerId, tournaments) {
            const items = { 1: [], 2: [], 3: [], booby: [] };

            const getFinish = (tournament) => {
                if (!tournament || !Array.isArray(tournament.final_standings)) return null;
                let idx = tournament.final_standings.findIndex(s => s && s.player === playerId);
                if (idx === -1) {
                    idx = tournament.final_standings.findIndex(s =>
                        s &&
                        s.is_partnership &&
                        Array.isArray(s.partnership_players) &&
                        s.partnership_players.some(p => p === playerId)
                    );
                }
                if (idx === -1) return null;
                return { place: idx + 1 };
            };

            (tournaments || []).forEach(t => {
                const finish = getFinish(t);
                if (!finish) return;
                if (finish.place === 1 || finish.place === 2 || finish.place === 3) {
                    items[finish.place].push({ year: t.year });
                    return;
                }
                const totalPlayers = (t && Array.isArray(t.final_standings)) ? t.final_standings.length : 0;
                if (totalPlayers && finish.place === totalPlayers) {
                    items.booby.push({ year: t.year });
                }
            });

            const total = items[1].length + items[2].length + items[3].length + items.booby.length;
            if (!total) {
                return `<div class="memorial-trophy-row memorial-trophy-row--empty"><span class="muted">No trophies recorded.</span></div>`;
            }

            const placeOrder = [
                { place: 1, emoji: 'üèÜ' },
                { place: 2, emoji: 'ü•à' },
                { place: 3, emoji: 'ü•â' },
                { place: 'booby', emoji: 'üé≠' }
            ];

            const flat = [];
            placeOrder.forEach(meta => {
                (items[meta.place] || [])
                    .slice()
                    .sort((a, b) => a.year - b.year)
                    .forEach(x => flat.push({ place: meta.place, emoji: meta.emoji, year: x.year }));
            });

            return `
                <div class="memorial-trophy-row" role="list" aria-label="Trophy cabinet">
                    ${flat.map(x => `
                        <div class="memorial-trophy-piece memorial-trophy-piece--${x.place}" role="listitem">
                            <div class="memorial-trophy-piece-emoji">${x.emoji}</div>
                            <div class="memorial-trophy-piece-year">${escapeHtml(x.year)}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function computeWinsAndTop3ForPlayer(playerId, tournaments) {
            let wins = 0;
            let top3 = 0;
            (tournaments || []).forEach(t => {
                if (!t || !Array.isArray(t.final_standings) || !t.final_standings.length) return;

                // Individual place
                const idx = t.final_standings.findIndex(s => s && s.player === playerId);
                if (idx !== -1) {
                    if (idx === 0) wins += 1;
                    if (idx <= 2) top3 += 1;
                    return;
                }

                // Shared-hand place
                const pIdx = t.final_standings.findIndex(s =>
                    s &&
                    s.is_partnership &&
                    Array.isArray(s.partnership_players) &&
                    s.partnership_players.some(p => p === playerId)
                );
                if (pIdx !== -1) {
                    if (pIdx === 0) wins += 1;
                    if (pIdx <= 2) top3 += 1;
                }
            });
            return { wins, top3 };
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const engine = new TournamentEngine();
            window.tournamentEngine = engine;
            const sheetId = '1HGfdlDOfGHOL6Q4MP_TnF8UNE6YihBW-5gQs6Ykl78k';
            const highlightId = getParam('player');

            try {
                await engine.loadFromGoogleSheets(sheetId);

                const roster = (engine.getPlayersRoster && typeof engine.getPlayersRoster === 'function')
                    ? engine.getPlayersRoster()
                    : [];

                const deceased = roster
                    .filter(p => p && typeof p.dateOfDeath === 'string' && p.dateOfDeath.trim())
                    .map(p => {
                        const death = (engine.getPlayerDeathInfo && typeof engine.getPlayerDeathInfo === 'function')
                            ? engine.getPlayerDeathInfo(p.id)
                            : null;
                        const deathYear = death && death.year ? death.year : null;
                        const deathLabel = death && death.raw ? (death.isYearOnly && death.year ? String(death.year) : death.raw) : p.dateOfDeath.trim();

                        const stats = (engine.getPlayer && typeof engine.getPlayer === 'function') ? engine.getPlayer(p.id) : null;
                        const tournamentsPlayed = stats && Number.isFinite(stats.tournaments_played) ? stats.tournaments_played : (stats ? parseInt(stats.tournaments_played || '0', 10) : 0);
                        const totalTricksNum = stats && Number.isFinite(stats.total_tricks) ? stats.total_tricks : (stats ? parseFloat(stats.total_tricks || '0') : 0);
                        const totalRoundsNum = stats && Number.isFinite(stats.total_rounds) ? stats.total_rounds : (stats ? parseInt(stats.total_rounds || '0', 10) : 0);

                        return {
                            id: p.id,
                            name: (engine.getPlayerFullName && typeof engine.getPlayerFullName === 'function') ? engine.getPlayerFullName(p.id) : (p.displayName || p.fullName || p.id),
                            deathYear,
                            deathLabel,
                            tournamentsPlayed: Number.isFinite(tournamentsPlayed) ? tournamentsPlayed : 0,
                            totalTricks: Number.isFinite(totalTricksNum) ? Math.floor(totalTricksNum) : 0,
                            totalRounds: Number.isFinite(totalRoundsNum) ? Math.floor(totalRoundsNum) : 0
                        };
                    })
                    .sort((a, b) => {
                        const ay = a.deathYear || 9999;
                        const by = b.deathYear || 9999;
                        return ay - by || a.name.localeCompare(b.name);
                    });

                const root = document.getElementById('memorial-list');
                if (!root) return;

                if (!deceased.length) {
                    root.innerHTML = `<div class="loading-message">No memorial entries yet.</div>`;
                    return;
                }

                root.innerHTML = deceased.map(d => {
                    const profileHref = `../players/profile.html?player=${encodeURIComponent(d.id)}`;
                    const initials = initialsFromName(d.name);
                    const highlight = (highlightId && String(highlightId).toLowerCase() === String(d.id).toLowerCase()) ? 'memorial-card--highlight' : '';

                    const tournaments = Array.from(engine.tournaments?.values?.() || []);
                    const playerTournaments = tournaments.filter(t => {
                        if (!t || !Array.isArray(t.final_standings)) return false;
                        const appearsIndividually = t.final_standings.some(s => s && s.player === d.id);
                        const appearsInSharedHands = t.final_standings.some(s =>
                            s &&
                            s.is_partnership &&
                            Array.isArray(s.partnership_players) &&
                            s.partnership_players.some(p => p === d.id)
                        );
                        return appearsIndividually || appearsInSharedHands;
                    });

                    const trophyCabinetHtml = renderTrophyCabinetHtml(d.id, playerTournaments);
                    const { wins, top3 } = computeWinsAndTop3ForPlayer(d.id, playerTournaments);

                    const avatarUrl = `/media/avatars/${encodeURIComponent(d.id)}.jpg`;

                    return `
                        <article class="memorial-card ${highlight}" id="memorial-${escapeHtml(d.id)}">
                            <div class="memorial-card__left">
                                <a class="memorial-avatar-link" href="${avatarUrl}" target="_blank" rel="noopener" aria-label="Open ${escapeHtml(d.name)} avatar">
                                    <div class="memorial-avatar" aria-label="${escapeHtml(d.name)} avatar">
                                        <img
                                            class="memorial-avatar__img"
                                            src="${avatarUrl}"
                                            alt="${escapeHtml(d.name)}"
                                            loading="lazy"
                                            decoding="async"
                                            onload="this.closest('.memorial-avatar').classList.add('memorial-avatar--has-img')"
                                            onerror="this.style.display='none'"
                                        >
                                        <div class="memorial-avatar__fallback" aria-hidden="true">${escapeHtml(initials)}</div>
                                    </div>
                                </a>

                                <div class="memorial-crest" aria-label="In memoriam">
                                    <div class="memorial-crest__title">üïäÔ∏è In memoriam</div>
                                    <div class="memorial-crest__date">‚Ä† ${escapeHtml(d.deathLabel)}</div>
                                </div>
                            </div>
                            <div class="memorial-card__body">
                                <div class="memorial-card__head">
                                    <a class="memorial-card__name" href="${profileHref}">${escapeHtml(d.name)}</a>
                                    <div class="memorial-card__death">Final stats</div>
                                </div>

                                <div class="memorial-trophy">
                                    <div class="memorial-trophy__label">Final trophy cabinet</div>
                                    ${trophyCabinetHtml}
                                </div>

                                <div class="memorial-stats">
                                    <div class="memorial-stat">
                                        <div class="memorial-stat__label">Total tricks</div>
                                        <div class="memorial-stat__value">${d.totalTricks.toLocaleString()}</div>
                                    </div>
                                    <div class="memorial-stat">
                                        <div class="memorial-stat__label">Total rounds played</div>
                                        <div class="memorial-stat__value">${d.totalRounds.toLocaleString()}</div>
                                    </div>
                                    <div class="memorial-stat">
                                        <div class="memorial-stat__label">Tournaments</div>
                                        <div class="memorial-stat__value">${d.tournamentsPlayed.toLocaleString()}</div>
                                    </div>
                                    <div class="memorial-stat">
                                        <div class="memorial-stat__label">Wins</div>
                                        <div class="memorial-stat__value">${Number(wins || 0).toLocaleString()}</div>
                                    </div>
                                    <div class="memorial-stat">
                                        <div class="memorial-stat__label">Top 3</div>
                                        <div class="memorial-stat__value">${Number(top3 || 0).toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                        </article>
                    `;
                }).join('');

                if (highlightId) {
                    const el = document.getElementById(`memorial-${highlightId}`);
                    if (el && typeof el.scrollIntoView === 'function') {
                        el.scrollIntoView({ block: 'center' });
                    }
                }
            } catch (e) {
                console.error(e);
                const root = document.getElementById('memorial-list');
                if (root) root.innerHTML = `<div class="loading-message">Error loading memorial.</div>`;
            }
        });
    </script>

    <style>
        .memorial-section {
            padding: var(--spacing-3xl) 0;
            /* Darker backdrop so the lighter memorial panels/trophies read clearly */
            background: linear-gradient(135deg, rgba(2, 6, 23, 0.96) 0%, rgba(15, 23, 42, 0.96) 100%);
        }

        .memorial-list {
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
        }

        .memorial-card {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 1.25rem;
            align-items: start;
            background: white;
            border-radius: var(--border-radius-lg);
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: var(--shadow-card);
            padding: 1rem 1.05rem;
        }

        .memorial-card--highlight {
            outline: 3px solid rgba(34, 197, 94, 0.22);
            box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.08), var(--shadow-card);
        }

        .memorial-card__left {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .memorial-avatar-link {
            display: inline-block;
            border-radius: 999px;
            text-decoration: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }

        .memorial-avatar-link:focus-visible {
            outline: 3px solid rgba(249, 115, 22, 0.35);
            outline-offset: 5px;
        }

        .memorial-avatar {
            width: 168px;
            height: 168px;
            border-radius: 999px;
            overflow: hidden;
            position: relative;
            background: rgba(15, 23, 42, 0.06);
            border: 2px solid rgba(15, 23, 42, 0.12);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.10);
        }

        .memorial-avatar__img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .memorial-avatar__fallback {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 3.1rem;
            letter-spacing: 0.06em;
            color: var(--text-primary-dark);
        }

        .memorial-avatar--has-img .memorial-avatar__fallback {
            display: none;
        }

        .memorial-crest {
            width: 100%;
            max-width: 220px;
            border-radius: 0;
            border: none;
            background: transparent;
            padding: 0;
            text-align: center;
        }

        .memorial-crest__title {
            font-weight: 900;
            color: var(--text-primary-dark);
            letter-spacing: 0.06em;
            text-transform: uppercase;
            font-size: 0.78rem;
        }

        .memorial-crest__date {
            margin-top: 0.25rem;
            color: var(--text-secondary-dark);
            font-weight: 800;
            font-size: 0.95rem;
        }

        .memorial-card__body {
            min-width: 0;
        }

        .memorial-card__head {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .memorial-card__name {
            font-family: var(--font-primary);
            font-weight: 900;
            color: var(--text-primary-dark);
            text-decoration: none;
            font-size: 1.25rem;
        }

        .memorial-card__name:hover {
            text-decoration: underline;
        }

        .memorial-card__death {
            color: var(--text-secondary-dark);
            font-weight: 800;
            white-space: nowrap;
        }

        .memorial-stats {
            margin-top: 0.75rem;
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 0.75rem;
        }

        .memorial-stat {
            background: rgba(15, 23, 42, 0.03);
            border: 1px solid rgba(15, 23, 42, 0.06);
            border-radius: 12px;
            padding: 0.7rem 0.75rem;
        }

        .memorial-trophy {
            margin-top: 0.9rem;
            padding: 0.9rem 0.95rem;
            border-radius: 14px;
            border: 1px solid rgba(15, 23, 42, 0.45);
            /* Lighter panel (on top of the now-darker section) */
            background: rgba(255, 255, 255, 0.97);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.92);
        }

        .memorial-trophy__label {
            color: var(--text-secondary-dark);
            font-weight: 900;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        .memorial-trophy-row {
            margin-top: 0.65rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: flex-start;
        }

        .memorial-trophy-row--empty {
            margin-top: 0.55rem;
        }

        .memorial-trophy-piece {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 64px;
            padding: 0.1rem 0;
            /* No tile/rounded-rect around each trophy */
            border: none;
            border-radius: 0;
            background: transparent;
            box-shadow: none;
        }

        .memorial-trophy-piece-emoji {
            font-size: 1.75rem;
            line-height: 1;
            filter: drop-shadow(0 1px 0 rgba(255, 255, 255, 0.35));
        }

        .memorial-trophy-piece-year {
            margin-top: 0.25rem;
            font-weight: 900;
            color: var(--text-primary-dark);
            font-size: 0.82rem;
            line-height: 1;
        }

        /* Keep subtle differentiation via emoji color hinting (no boxes) */
        .memorial-trophy-piece--1 .memorial-trophy-piece-emoji { filter: drop-shadow(0 0 10px rgba(245, 158, 11, 0.20)); }
        .memorial-trophy-piece--2 .memorial-trophy-piece-emoji { filter: drop-shadow(0 0 10px rgba(148, 163, 184, 0.22)); }
        .memorial-trophy-piece--3 .memorial-trophy-piece-emoji { filter: drop-shadow(0 0 10px rgba(234, 179, 8, 0.14)); }
        .memorial-trophy-piece--booby .memorial-trophy-piece-emoji { filter: drop-shadow(0 0 10px rgba(244, 63, 94, 0.16)); }

        @media (max-width: 520px) {
            .memorial-trophy-piece {
                width: 70px;
            }
            .memorial-trophy-piece-emoji {
                font-size: 1.9rem;
            }
            .memorial-trophy-piece-year {
                font-size: 0.85rem;
            }
        }

        .memorial-stat__label {
            color: var(--text-secondary-dark);
            font-weight: 700;
            font-size: 0.85rem;
        }

        .memorial-stat__value {
            margin-top: 0.15rem;
            color: var(--text-primary-dark);
            font-weight: 900;
            font-size: 1.05rem;
        }

        @media (max-width: 900px) {
            .memorial-stats {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .memorial-card {
                grid-template-columns: 200px 1fr;
            }
            .memorial-avatar {
                width: 152px;
                height: 152px;
            }
        }

        @media (max-width: 520px) {
            .memorial-card {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .memorial-card__left {
                align-items: center;
            }
            .memorial-avatar {
                width: 210px;
                height: 210px;
            }
            .memorial-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>
